<ng-template #content let-close="close" let-dismiss="dismiss">
  <div class="modal-header border-0 pb-0">
    <div>
      <h5 class="modal-title fw-semibold">Update your temporary password</h5>
      <p class="text-neutral-600 small mb-0">Set a new password to secure your account</p>
    </div>
    <button type="button" class="btn-close" aria-label="Close" (click)="dismiss('close')"></button>
  </div>
  <div class="modal-body pt-3">
    <form [formGroup]="accountForm" class="row g-3">
      <div class="col-12">
        <label class="form-label fw-semibold" for="dashboardPassword">New password</label>
        <div class="input-group has-validation">
          <span class="input-group-text">
            <i class="bi bi-shield-lock"></i>
          </span>
          <input
            type="password"
            id="dashboardPassword"
            class="form-control"
            placeholder="Enter new password"
            formControlName="password"
            required
          />
        </div>
        <div
          class="invalid-feedback d-block"
          *ngIf="accountForm.get('password')?.invalid && (accountForm.get('password')?.dirty || accountForm.get('password')?.touched)"
        >
          Password is required.
        </div>
      </div>
      <div class="col-12">
        <label class="form-label fw-semibold" for="dashboardConfirmPassword">Confirm password</label>
        <div class="input-group has-validation">
          <span class="input-group-text">
            <i class="bi bi-shield-check"></i>
          </span>
          <input
            type="password"
            id="dashboardConfirmPassword"
            class="form-control"
            placeholder="Re-enter password"
            formControlName="confirmPassword"
            required
          />
        </div>
        <div
          class="invalid-feedback d-block"
          *ngIf="accountForm.get('confirmPassword')?.invalid && (accountForm.get('confirmPassword')?.dirty || accountForm.get('confirmPassword')?.touched)"
        >
          Confirmation is required.
        </div>
        <div
          class="invalid-feedback d-block"
          *ngIf="
            accountForm.get('password')?.value &&
            accountForm.get('confirmPassword')?.value &&
            accountForm.get('password')?.value !== accountForm.get('confirmPassword')?.value
          "
        >
          Passwords do not match.
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer border-0 pt-0">
    <button type="button" class="btn btn-outline-secondary" (click)="dismiss('cancel')">Cancel</button>
    <button
      type="button"
      class="btn btn-primary"
      (click)="onSave()"
      [disabled]="accountForm.invalid || accountForm.get('password')?.value !== accountForm.get('confirmPassword')?.value"
    >
      Save password
    </button>
  </div>
</ng-template>

<div class="dashboard-page container-fluid py-3">
  @if (!functionCalled) {
    <div class="card shadow-sm border-0 skeleton-card mb-3">
      <div class="card-body text-center py-5">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="visually-hidden">Loading dashboard…</span>
        </div>
        <p class="text-neutral-600 mb-0">Preparing your dashboard insights…</p>
      </div>
    </div>
  }

  @if (functionCalled) {
    <section class="row g-3 align-items-stretch">
      @for (metric of summaryMetrics; track metric.label) {
        <div class="col-12 col-sm-6 col-xl-3">
          <article class="card stat-card border-0 shadow-sm h-100">
            <div class="card-body d-flex flex-column gap-3">
              <div class="d-flex align-items-start justify-content-between">
                <div>
                  <p class="stat-card__label text-uppercase small text-neutral-600 mb-1">{{ metric.label }}</p>
                  <h2 class="stat-card__value mb-0">{{ metric.value | number }}</h2>
                </div>
                <span class="stat-card__icon" [ngClass]="metric.accent" [attr.title]="metric.tooltip">
                  <i class="bi" [ngClass]="metric.icon"></i>
                </span>
              </div>
              <p class="stat-card__meta text-neutral-500 small mb-0" *ngIf="metric.subtitle">
                {{ metric.subtitle }}
              </p>
            </div>
          </article>
        </div>
      }
    </section>

    <section class="row g-3 align-items-stretch mt-1">
      <div class="col-12 col-xl-8">
        <section class="card shadow-sm border-0 h-100">
          <div class="card-header border-0 pb-0 d-flex flex-wrap gap-2 align-items-center justify-content-between">
            <div>
              <h5 class="mb-1">Enrollment Growth</h5>
              <p class="text-neutral-600 small mb-0">Monthly student onboarding across your institution</p>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary d-flex align-items-center gap-1"
                (click)="refreshDashboard()"
              >
                <i class="bi bi-arrow-repeat"></i>
                Refresh
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <ng-container *ngIf="chartOptions?.series?.length; else emptyChart">
                <apx-chart
                  [series]="chartOptions?.series"
                  [chart]="chartOptions?.chart"
                  [dataLabels]="chartOptions?.dataLabels"
                  [plotOptions]="chartOptions?.plotOptions"
                  [yaxis]="chartOptions?.yaxis"
                  [legend]="chartOptions?.legend"
                  [fill]="chartOptions?.fill"
                  [stroke]="chartOptions?.stroke"
                  [tooltip]="chartOptions?.tooltip"
                  [xaxis]="chartOptions?.xaxis"
                ></apx-chart>
              </ng-container>
              <ng-template #emptyChart>
                <div class="empty-state text-center py-5">
                  <i class="bi bi-bar-chart-line fs-1 text-neutral-400"></i>
                  <p class="text-neutral-600 mt-3 mb-0">
                    We’ll visualize enrollment trends as soon as data is available.
                  </p>
                </div>
              </ng-template>
            </div>
          </div>
        </section>
      </div>

      <div class="col-12 col-xl-4">
        <section class="card shadow-sm border-0 h-100">
          <div class="card-header border-0 pb-0">
            <h5 class="mb-1">Institution Snapshot</h5>
            <p class="text-neutral-600 small mb-0">
              Key metrics for {{ institutionName || 'your institution' }}
            </p>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item px-0 d-flex align-items-center justify-content-between">
                <span class="text-neutral-600">Primary institution</span>
                <span class="fw-semibold text-neutral-900 text-end">{{ institutionName || '—' }}</span>
              </li>
              <li class="list-group-item px-0 d-flex align-items-center justify-content-between">
                <span class="text-neutral-600">Linked campuses</span>
                <span class="fw-semibold text-neutral-900 text-end">{{ schoolStatus?.length || 0 }}</span>
              </li>
              <li class="list-group-item px-0 d-flex align-items-center justify-content-between">
                <span class="text-neutral-600">Last roster update</span>
                <span class="fw-semibold text-neutral-900 text-end">
                  <ng-container *ngIf="orderList?.length && orderList[0]?.created_date; else noRosterDate">
                    {{ orderList[0].created_date | customDateFormat }}
                  </ng-container>
                  <ng-template #noRosterDate>—</ng-template>
                </span>
              </li>
            </ul>

            <div class="snapshot-metrics mt-4">
              <ng-container *ngIf="institutionMetrics.length; else noInstitutionMetrics">
                @for (metric of institutionMetrics; track metric.label) {
                  <div class="snapshot-metric border rounded-3 p-3">
                    <p class="text-neutral-600 small text-uppercase mb-1">{{ metric.label }}</p>
                    <h4 class="fw-semibold mb-0">{{ metric.value | number }}</h4>
                    <p class="text-neutral-500 small mb-0" *ngIf="metric.caption">{{ metric.caption }}</p>
                  </div>
                }
              </ng-container>
              <ng-template #noInstitutionMetrics>
                <div class="empty-state text-center py-4">
                  <i class="bi bi-collection text-neutral-400 fs-4"></i>
                  <p class="text-neutral-600 small mb-0 mt-2">Institution activity metrics will appear here.</p>
                </div>
              </ng-template>
            </div>
          </div>
        </section>
      </div>
    </section>

    <section class="row g-3 align-items-stretch mt-1">
      <div class="col-12 col-xxl-6">
        <section class="card shadow-sm border-0 h-100">
          <div class="card-header border-0 pb-0 d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div>
              <h5 class="mb-1">Content Overview</h5>
              <p class="text-neutral-600 small mb-0">Recent activity across content repositories</p>
            </div>
          </div>
          <div class="card-body">
            <ng-container *ngIf="chartOptions1?.series?.length; else emptyContentChart">
              <apx-chart
                [series]="chartOptions1?.series"
                [chart]="chartOptions1?.chart"
                [xaxis]="chartOptions1?.xaxis"
                [dataLabels]="chartOptions1?.dataLabels"
                [grid]="chartOptions1?.grid"
                [stroke]="chartOptions1?.stroke"
                [title]="chartOptions1?.title"
              ></apx-chart>
            </ng-container>
            <ng-template #emptyContentChart>
              <div class="empty-state text-center py-5">
                <i class="bi bi-stack fs-1 text-neutral-400"></i>
                <p class="text-neutral-600 mt-3 mb-0">
                  Start publishing lessons to view content performance analytics.
                </p>
              </div>
            </ng-template>
          </div>
        </section>
      </div>

      <div class="col-12 col-xxl-6">
        <section class="card shadow-sm border-0 h-100">
          <div class="card-header border-0 pb-0">
            <h5 class="mb-1">Institution Status</h5>
            <p class="text-neutral-600 small mb-0">Class creation and editing trends</p>
          </div>
          <div class="card-body">
            <ng-container *ngIf="institutionMetrics.length; else noInstitutionStatus">
              <div class="row g-3">
                @for (metric of institutionMetrics; track metric.label) {
                  <div class="col-6">
                    <div class="status-tile border rounded-3 p-3 h-100">
                      <span class="status-tile__label text-neutral-600 small text-uppercase">{{ metric.label }}</span>
                      <span class="status-tile__value fw-semibold">{{ metric.value | number }}</span>
                      <span class="status-tile__caption text-neutral-500 small" *ngIf="metric.caption">
                        {{ metric.caption }}
                      </span>
                    </div>
                  </div>
                }
              </div>
            </ng-container>
            <ng-template #noInstitutionStatus>
              <div class="empty-state text-center py-4">
                <i class="bi bi-building-up text-neutral-400 fs-4"></i>
                <p class="text-neutral-600 small mb-0 mt-2">
                  Once classes are created, we’ll surface institution trends here.
                </p>
              </div>
            </ng-template>
          </div>
        </section>
      </div>
    </section>

    <section class="card shadow-sm border-0 mt-3">
      <div class="card-header border-0 pb-0 d-flex flex-wrap align-items-center justify-content-between gap-2">
        <div>
          <h5 class="mb-1">School Directory</h5>
          <p class="text-neutral-600 small mb-0">
            Overview of connected institutions with quick actions.
          </p>
        </div>
        <span class="badge rounded-pill bg-light-subtle text-neutral-700">
          {{ orderList?.length || 0 }} listed
        </span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-modern align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col">Institution</th>
                <th scope="col" class="text-center">Teachers</th>
                <th scope="col" class="text-center">Students</th>
                <th scope="col" class="text-center">Content creators</th>
                <th scope="col" class="text-center">Created</th>
                <th scope="col" class="text-center">Status</th>
              </tr>
            </thead>
            <tbody>
              @if (orderList?.length) {
                @for (item of orderList; track $index) {
                  <tr>
                    <td>
                      <div class="d-flex flex-column">
                        <span class="fw-semibold text-neutral-900">
                          {{ item.name || item.school_name || '—' }}
                        </span>
                        <small class="text-neutral-500" *ngIf="item.school_code || item.code">
                          Code: {{ item.school_code || item.code }}
                        </small>
                      </div>
                    </td>
                    <td class="text-center">
                      <span class="badge rounded-pill bg-primary-subtle text-primary fw-semibold">
                        {{ item.teachers || 0 }}
                      </span>
                    </td>
                    <td class="text-center">
                      <span class="badge rounded-pill bg-secondary-subtle text-secondary fw-semibold">
                        {{ item.students || 0 }}
                      </span>
                    </td>
                    <td class="text-center">
                      <span class="badge rounded-pill bg-info-subtle text-info fw-semibold">
                        {{ item.content_creator || item.content_creators || 0 }}
                      </span>
                    </td>
                    <td class="text-center">
                      <ng-container *ngIf="item.created_date; else noCreatedDate">
                        {{ item.created_date | customDateFormat }}
                      </ng-container>
                      <ng-template #noCreatedDate>—</ng-template>
                    </td>
                    <td class="text-center">
                      <span class="badge rounded-pill fw-semibold" [ngClass]="getStatusTone(item.status)">
                        {{ getStatusLabel(item.status) }}
                      </span>
                    </td>
                  </tr>
                }
              } @else {
                <tr>
                  <td colspan="6">
                    <div class="empty-state text-center py-5">
                      <i class="bi bi-houses fs-1 text-neutral-400"></i>
                      <p class="text-neutral-600 mt-3 mb-0">
                        Connect your first school to populate the directory.
                      </p>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </section>
  }
</div>
