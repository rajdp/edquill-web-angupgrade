<!-- Container-fluid starts-->

<div *ngIf="schoolStatus.length != 0" class="container-fluid">
    <!-- Tab Navigation and Action Buttons -->
    <div class="content-header mb-4">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <!-- Tabs -->
            <ul class="nav nav-tabs content-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button 
                        class="nav-link" 
                        [class.active]="activeTab === 'library'"
                        type="button"
                        role="tab"
                        (click)="switchTab('library')"
                        aria-label="Content Library view">
                        <i class="fa fa-book me-2" aria-hidden="true"></i>
                        Content Library
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button 
                        class="nav-link" 
                        [class.active]="activeTab === 'folder'"
                        type="button"
                        role="tab"
                        (click)="switchTab('folder')"
                        aria-label="Content Folder view">
                        <i class="fa fa-folder me-2" aria-hidden="true"></i>
                        Content Folder
                    </button>
                </li>
            </ul>
            
            <!-- Action Buttons -->
            <div class="d-flex flex-wrap align-items-center gap-2">
                <button class="btn btn-outline-primary" (click)="multiAssignContent()" *ngIf="multiContent.length > 0">
                    <i class="fa fa-users me-1" aria-hidden="true"></i>
                    Assign Selected ({{multiContent.length}})
                </button>
                <button class="btn btn-outline-secondary" *ngIf="manageContentFolder" (click)="addItem('0', 'parent', 'add')">
                    <i class="fas fa-folder-plus me-1" aria-hidden="true"></i>
                    Add Folder
                </button>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body p-4">
            <div class="row">
                <div class="col-4">
                    <input (input)="onSearch($event)" class="form-control align-content-center" placeholder="Search Content Folder">
                </div>
                <div class="col-8 py-2 d-flex justify-content-end">

                    <i class="fas fa-{{expandAll ? 'compress' : 'expand'}}-alt color-primary main_assign btn cursor mr-2" aria-hidden="true"
                       [title]="expandAll ? 'Collapse All' : 'Expand All'" (click)="expandOrCollapseAll()"></i>

                    <div class="dropdown px-2">

                        <button class="col-12 float-right btn btn-outline-primary">{{filterType}} <i class="fa fa-sort-desc float-right pl-2" aria-hidden="true"></i></button>

                        <div class="dropdown-content" style="z-index: 2; top: 38px;">
                            <a (click)="filterType = 'Latest';getBranchList()" class="cursor">Latest</a>
                            <a (click)="filterType = 'Oldest';getBranchList()" class="cursor">Oldest</a>
                            <a (click)="filterType = 'A - Z';getBranchList()" class="cursor">A - Z</a>
                            <a (click)="filterType = 'Z - A';getBranchList()" class="cursor">Z - A</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 my-3 content-tree-container">
                    <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="content-tree">
                        <mat-nested-tree-node *matTreeNodeDef="let node; when: folderNodePredicate">
                            <div class="content-tree__node content-tree__node--folder" matTreeNodePadding>
                                <button mat-icon-button matTreeNodeToggle
                                        *ngIf="hasChildren(node)"
                                        class="content-tree__toggle"
                                        (click)="$event.stopPropagation()"
                                        [attr.aria-label]="treeControl.isExpanded(node) ? 'Collapse folder ' + node.text : 'Expand folder ' + node.text">
                                    <i class="fa" [ngClass]="treeControl.isExpanded(node) ? 'fa-caret-down' : 'fa-caret-right'" aria-hidden="true"></i>
                                </button>
                                <span class="content-tree__toggle-spacer" *ngIf="!hasChildren(node)"></span>
                                <mat-checkbox
                                    class="content-tree__checkbox"
                                    (click)="$event.stopPropagation()"
                                    (change)="onFolderSelectionChange(node, $event)"
                                    [checked]="node.checked"
                                    [indeterminate]="node.indeterminate"
                                    [disabled]="!hasChildren(node)">
                                </mat-checkbox>
                                <span class="content-tree__label" [title]="node.text">{{ node.text }}</span>
                                <div class="content-tree__actions">
                                    <button type="button" class="btn btn-link btn-sm p-0"
                                            *ngIf="manageContentFolder"
                                            (click)="addItem(node, 'child', 'add', $event)">
                                        <i class="fas fa-folder-plus color-primary" aria-hidden="true"></i>
                                    </button>
                                    <button type="button" class="btn btn-link btn-sm p-0"
                                            *ngIf="manageContentFolder && node.value.split('/')[3] == '1'"
                                            (click)="addItem(node, 'parent', 'edit', $event)">
                                        <i class="fa fa-pencil color-primary" aria-hidden="true"></i>
                                    </button>
                                    <button type="button" class="btn btn-link btn-sm p-0"
                                            *ngIf="node.value.split('/')[3] == '1'"
                                            (click)="batchDeletePopUp(node, $event)">
                                        <i class="fa fa-trash color-red" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="content-tree__children" *ngIf="treeControl.isExpanded(node)">
                                <ng-container matTreeNodeOutlet></ng-container>
                            </div>
                        </mat-nested-tree-node>

                        <mat-tree-node *matTreeNodeDef="let node; when: fileNodePredicate" matTreeNodePadding>
                            <div class="content-tree__node content-tree__node--file">
                                <mat-checkbox
                                    class="content-tree__checkbox"
                                    (click)="$event.stopPropagation()"
                                    (change)="onFileSelectionChange(node, $event)"
                                    [checked]="node.checked"
                                    [indeterminate]="node.indeterminate"
                                    [disabled]="node.disabled">
                                </mat-checkbox>
                                <div class="content-tree__file-meta" [title]="node.text">
                                    <i *ngIf="node.value?.split('/')[2] == '1'" class="fa fa-book text-info" aria-hidden="true"></i>
                                    <i *ngIf="node.value?.split('/')[2] == '2'" class="fas fa-tasks text-warning" aria-hidden="true"></i>
                                    <i *ngIf="node.value?.split('/')[2] == '3'" class="fa fa-file-text text-primary" aria-hidden="true"></i>
                                    <button type="button"
                                            class="btn btn-link p-0 content-tree__file-link"
                                            (click)="previewOrEditContent(node, 'preview')">
                                        {{ node.text }}
                                    </button>
                                    <span class="badge badge-danger ml-2" *ngIf="node.value?.split('/')[3] == '1'">PDF</span>
                                    <span class="badge badge-secondary ml-2" *ngIf="node.value?.split('/')[3] == '3'">TEXT</span>
                                </div>
                                <div class="content-tree__actions">
                                    <button type="button" class="btn btn-link btn-sm p-0" title="Preview Content"
                                            (click)="previewOrEditContent(node, 'preview')">
                                        <i class="fa fa-eye color-primary" aria-hidden="true"></i>
                                    </button>
                                    <button type="button" class="btn btn-link btn-sm p-0"
                                            *ngIf="(roleId == '4' && manageContentFolder && node.edit_status == '1') ||
                                                (roleId == '6' && node.edit_status != '0') || (roleId == '2' && !(schoolId != node.school_id && node.access == '3') && node.access != '4')"
                                            title="Edit Content"
                                            (click)="previewOrEditContent(node, 'edit')">
                                        <i class="fa fa-pencil color-primary" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </mat-tree-node>
                    </mat-tree>

                    <div *ngIf="branchListData.length === 0" class="content-tree__empty">
                        <button class="nodataList">No Data Available!</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div *ngIf="schoolStatus.length == 0">
    <app-emptyschool>
    </app-emptyschool>
</div>
<!-- Container-fluid Ends-->

<ng-template #assignContent>
    <app-confirm-content-assign
        [contentDetails]="contentDetails"
        [classData]="classDetails"
        [multiContentId]="multiContent"
        [isEssay]="isEssay"
        (closePopUp)="close($event)"
    >
    </app-confirm-content-assign>
</ng-template>

<ng-template #addBranch let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="col-md-11 px-2 py-1 font-weight-bold mb-0">{{calledValue == 'add' ? 'Add' : 'Rename'}} Folder</h4>
    </div>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12">
                <form [formGroup]="branchForm" class="needs-validation user-add" novalida>
                    <div class="form-group row">
                        <label for="validationCustom1" class="col-xl-3 col-md-4"><span>*</span>
                            Content Folder Name </label>
                        <div class="col-xl-8 col-md-7">
                            <input class="form-control" formControlName="batchname" id="validat1ionCustom1"
                                   type="text" placeholder="Enter Content Folder Name" required="" (input)="formSubmitted = true">
                            <em *ngIf="!branchForm.get('batchname').valid && !formSubmitted"
                                class="error">Enter Content Folder Name</em>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal-footer pull-right">
        <button type="button" (click)="close('')" class="btn cancel">Cancel
        </button>
        <button type="button" (click)="addBranchDetails()" class="btn btn-primary">{{calledValue == 'add' ? 'Add' : 'Update'}}
        </button>
    </div>
</ng-template>

<ng-template #deleteBatch let-c="close" let-d="dismiss">
    <div class="modal-header">
        <h4 class="col-md-11 px-2 font-weight-bold mb-0">Delete Folder</h4>
    </div>
    <div class="modal-body">
        <div class="row">
            <div class="col-md-12 px-4">
                <h5>Are you sure want to delete the <span class="color-primary font-weight-bold">{{selectedBatchForDelete.text}}</span> folder ?</h5>
            </div>
        </div>
    </div>
    <div class="modal-footer pull-right">
        <button type="button" (click)="close('')" class="btn cancel">No
        </button>
        <button type="button" (click)="deleteBatchService()" class="btn btn-danger">Yes
        </button>
    </div>
</ng-template>

<ng-template #viewContent>
    <div class="modal-header align-items-center">
        <h4 class="modal-title">Preview</h4>
        <i class="fa fa-close cursor" (click)="closePopUp()"></i>
    </div>
    <div class="modal-body" style="background: #f8f8f9;">
        <app-preview (closePopUp)="closePopUp()" [calledBy]="'popUp'" [contentData]="contentData"></app-preview>
    </div>
</ng-template>
