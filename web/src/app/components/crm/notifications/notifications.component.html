<div class="row g-4">
  <div class="col-lg-4">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Message Template</h5>
      </div>
      <div class="card-body">
        <form [formGroup]="templateForm" (ngSubmit)="saveTemplate()">
          <div class="mb-3">
            <label class="form-label">Template Name *</label>
            <input class="form-control" placeholder="Payment Reminder" formControlName="name" />
          </div>
          <div class="mb-3">
            <label class="form-label">Channel *</label>
            <select class="form-select" formControlName="channel">
              <option value="both">SMS & Email</option>
              <option value="email">Email</option>
              <option value="sms">SMS</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Subject</label>
            <input class="form-control" placeholder="Only for emails" formControlName="subject" />
          </div>
          <div class="mb-3">
            <label class="form-label">Body *</label>
            <textarea class="form-control" rows="5" formControlName="body" placeholder="Hi &#123;guardian_name&#125;, ..."></textarea>
            <small class="text-muted">
              Use placeholders like &#123;student_name&#125;, &#123;amount_due&#125;, &#123;class_date&#125;
            </small>
          </div>
          <button class="btn btn-primary w-100" type="submit" [disabled]="savingTemplate">
            <span *ngIf="savingTemplate" class="spinner-border spinner-border-sm me-2"></span>
            Save Template
          </button>
        </form>
      </div>
    </div>

    <div class="card template-list">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Saved Templates</h6>
        <span *ngIf="loadingTemplates" class="spinner-border spinner-border-sm"></span>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush">
          <button class="list-group-item list-group-item-action" type="button" *ngFor="let template of templates" (click)="templateForm.patchValue(template)">
            <div class="fw-semibold">{{ template.name }}</div>
            <div class="text-muted small">Channel: {{ template.channel | uppercase }}</div>
          </button>
          <div class="list-group-item text-center text-muted" *ngIf="!templates.length && !loadingTemplates">
            No templates available yet.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Send Notification</h5>
      </div>
      <div class="card-body">
        <form [formGroup]="queueForm" (ngSubmit)="queueNotification()">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Template *</label>
              <select class="form-select" formControlName="template_id">
                <option value="" disabled>Select template</option>
                <option *ngFor="let template of templates" [value]="template.id">{{ template.name }}</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Channel *</label>
              <select class="form-select" formControlName="channel">
                <option value="email">Email</option>
                <option value="sms">SMS</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Recipient Type *</label>
              <select class="form-select" formControlName="recipient_type">
                <option value="guardian">Guardian</option>
                <option value="student">Student</option>
              </select>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-6" *ngIf="queueForm.value.recipient_type === 'guardian'">
              <label class="form-label">Guardian *</label>
              <select class="form-select" formControlName="recipient_id">
                <option value="" disabled>Select guardian</option>
                <option *ngFor="let guardian of guardians" [value]="guardian.id">{{ guardian.full_name }} ({{ guardian.email || guardian.phone || 'No contact' }})</option>
              </select>
            </div>
            <div class="col-md-6" *ngIf="queueForm.value.recipient_type === 'student'">
              <label class="form-label">Student *</label>
              <select class="form-select" formControlName="recipient_id">
                <option value="" disabled>Select student</option>
                <option *ngFor="let student of students" [value]="student.id">{{ student.full_name }}</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Related Student</label>
              <select class="form-select" formControlName="student_id">
                <option value="">Optional</option>
                <option *ngFor="let student of students" [value]="student.id">{{ student.full_name }}</option>
              </select>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">Variables</label>
            <textarea
              class="form-control"
              rows="2"
              formControlName="variablesText"
              placeholder='JSON or key:value pairs (e.g. &#123;"amount_due": "125"&#125;)'
            ></textarea>
          </div>

          <button class="btn btn-outline-primary mt-3" type="submit" [disabled]="queuing">
            <span *ngIf="queuing" class="spinner-border spinner-border-sm me-2"></span>
            Queue Notification
          </button>
        </form>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Opt-out Preferences</h5>
      </div>
      <div class="card-body">
        <form [formGroup]="optoutForm" (ngSubmit)="updateOptout()" class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Type</label>
            <select class="form-select" formControlName="contact_type">
              <option value="guardian">Guardian</option>
              <option value="student">Student</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Contact</label>
            <select class="form-select" formControlName="contact_id">
              <option value="" disabled>Select contact</option>
              <ng-container *ngIf="optoutForm.get('contact_type')?.value === 'guardian'; else studentOptions">
                <option *ngFor="let guardian of guardians" [value]="guardian.id">{{ guardian.full_name }}</option>
              </ng-container>
              <ng-template #studentOptions>
                <option *ngFor="let student of students" [value]="student.id">{{ student.full_name }}</option>
              </ng-template>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Channel</label>
            <select class="form-select" formControlName="channel">
              <option value="email">Email</option>
              <option value="sms">SMS</option>
            </select>
          </div>
          <div class="col-md-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" formControlName="opted_out" id="optoutSwitch" />
              <label class="form-check-label" for="optoutSwitch">Opted Out</label>
            </div>
            <input class="form-control mt-2" placeholder="Reason (optional)" formControlName="reason" />
          </div>
          <div class="col-12">
            <button class="btn btn-outline-secondary" type="submit" [disabled]="updatingOptout">
              <span *ngIf="updatingOptout" class="spinner-border spinner-border-sm me-2"></span>
              Update Preference
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Notification Activity</h5>
        <span *ngIf="loadingNotifications" class="spinner-border spinner-border-sm"></span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead>
              <tr>
                <th>Recipient</th>
                <th>Channel</th>
                <th>Status</th>
                <th>Scheduled</th>
                <th>Payload</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of notifications | slice:0:10">
                <td>{{ item.recipient_type | titlecase }} #{{ item.recipient_id }}</td>
                <td class="text-uppercase">{{ item.channel }}</td>
                <td>
                  <span class="badge" [ngClass]="item.status === 'sent' ? 'bg-success' : item.status === 'failed' ? 'bg-danger' : 'bg-secondary'">
                    {{ item.status | titlecase }}
                  </span>
                </td>
                <td>{{ item.scheduled_at ? (item.scheduled_at | date: 'short') : 'Immediate' }}</td>
                <td>
                  <pre class="payload-preview" *ngIf="item.payload">{{ item.payload | json }}</pre>
                </td>
              </tr>
              <tr *ngIf="!notifications.length && !loadingNotifications">
                <td colspan="5" class="text-center text-muted py-3">No notifications queued yet.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
