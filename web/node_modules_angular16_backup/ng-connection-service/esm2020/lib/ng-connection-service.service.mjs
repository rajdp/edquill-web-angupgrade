import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { BehaviorSubject, fromEvent, interval, Subscription, switchMap } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
/**
 * InjectionToken for specifing ConnectionService options.
 */
export const ConnectionServiceOptionsToken = new InjectionToken('ConnectionServiceOptionsToken');
export const DEFAULT_CONNECTION_STATE = {
    hasInternetAccess: true,
    hasNetworkConnection: window.navigator.onLine
};
export const DEFAULT_HEART_BEAT_INTERVAL = 1000;
// export const DEFAULT_HEART_BEAT_URL = 'https://jsonplaceholder.typicode.com';
export const DEFAULT_HEART_BEAT_URL = 'http://localhost:3000';
export const DEFAULT_HEART_BEAT_RETRY_INTERVAL = 1000;
export var HTTP_REQUEST_METHODS;
(function (HTTP_REQUEST_METHODS) {
    HTTP_REQUEST_METHODS["HEAD"] = "head";
    HTTP_REQUEST_METHODS["GET"] = "get";
    HTTP_REQUEST_METHODS["POST"] = "post";
    HTTP_REQUEST_METHODS["PUT"] = "put";
    HTTP_REQUEST_METHODS["OPTIONS"] = "options";
})(HTTP_REQUEST_METHODS || (HTTP_REQUEST_METHODS = {}));
export const DEFAULT_OPTIONS = {
    enableHeartbeat: false,
    heartbeatUrl: DEFAULT_HEART_BEAT_URL,
    heartbeatInterval: DEFAULT_HEART_BEAT_INTERVAL,
    heartbeatRetryInterval: 1000,
    requestMethod: HTTP_REQUEST_METHODS.HEAD
};
export class ConnectionService {
    constructor(http, options) {
        this.http = http;
        this.currentState = DEFAULT_CONNECTION_STATE;
        this.serviceOptions = DEFAULT_OPTIONS;
        this.subscription = new Subscription();
        this.httpSubscription = new Subscription();
        this.stateChanged$ = new BehaviorSubject(DEFAULT_CONNECTION_STATE);
        // TODO: Token useValue in providers not working.
        this.serviceOptions = { ...DEFAULT_OPTIONS, ...options };
        this.checkNetworkState();
        if (this.serviceOptions.enableHeartbeat) {
            this.checkInternetState();
        }
    }
    checkNetworkState() {
        this.subscription.add(fromEvent(window, 'online').subscribe(() => {
            this.currentState.hasNetworkConnection = true;
            this.checkInternetState();
            this.publishState();
        }));
        this.subscription.add(fromEvent(window, 'offline').subscribe(() => {
            this.currentState.hasNetworkConnection = false;
            this.checkInternetState();
            this.publishState();
        }));
    }
    checkInternetState() {
        if (this.serviceOptions.enableHeartbeat) {
            this.subscription = interval(3000).pipe(switchMap(async () => this.http[this.serviceOptions.requestMethod || HTTP_REQUEST_METHODS.HEAD](this.serviceOptions.heartbeatUrl || DEFAULT_HEART_BEAT_URL, { responseType: 'text' }).subscribe({
                next: (data) => {
                    this.currentState.hasInternetAccess = true;
                    this.publishState();
                },
                error: (err) => {
                    this.currentState.hasInternetAccess = false;
                    this.publishState();
                    throw err;
                },
            }))).subscribe(res => {
            });
            // this.httpSubscription = timer(0, this.serviceOptions.heartbeatInterval || DEFAULT_HEART_BEAT_INTERVAL)
            //   .pipe(
            //     switchMap(async () => this.http[this.serviceOptions.requestMethod || HTTP_REQUEST_METHODS.HEAD](this.serviceOptions.heartbeatUrl || DEFAULT_HEART_BEAT_URL,
            //       { responseType: 'text' })),
            //     retryWhen(errors =>
            //       errors.pipe(
            //         // log error message
            //         tap(val => {
            //           this.currentState.hasInternetAccess = false;
            //           this.publishState();
            //           throw errors;
            //         }),
            //         // restart after 5 seconds
            //         delay(this.serviceOptions.heartbeatRetryInterval || DEFAULT_HEART_BEAT_RETRY_INTERVAL)
            //       )
            //     )
            //   )
            //   .subscribe(result => {
            //     this.currentState.hasInternetAccess = true;
            //     this.publishState();
            //   });
        }
        else {
            this.currentState.hasInternetAccess = false;
            this.publishState();
        }
    }
    publishState() {
        this.stateChanged$.next(this.currentState);
    }
    /**
   * Monitor Network & Internet connection status by subscribing to this observer. If you set "reportCurrentState" to "false" then
   * function will not report current status of the connections when initially subscribed.
   * @param reportCurrentState Report current state when initial subscription. Default is "true"
   */
    monitor(options) {
        if (options) {
            this.serviceOptions = { ...this.serviceOptions, ...options };
        }
        if (this.serviceOptions.enableHeartbeat) {
            this.checkInternetState();
        }
        return this.stateChanged$;
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
}
ConnectionService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: ConnectionService, deps: [{ token: i1.HttpClient }, { token: ConnectionServiceOptionsToken, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
ConnectionService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: ConnectionService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.4", ngImport: i0, type: ConnectionService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.HttpClient }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [ConnectionServiceOptionsToken]
                }, {
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctY29ubmVjdGlvbi1zZXJ2aWNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1jb25uZWN0aW9uLXNlcnZpY2Uvc3JjL2xpYi9uZy1jb25uZWN0aW9uLXNlcnZpY2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQWEsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3hGLE9BQU8sRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBYyxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDOzs7QUE4Q2pHOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sNkJBQTZCLEdBQTZDLElBQUksY0FBYyxDQUFDLCtCQUErQixDQUFDLENBQUM7QUFFM0ksTUFBTSxDQUFDLE1BQU0sd0JBQXdCLEdBQW9CO0lBQ3ZELGlCQUFpQixFQUFFLElBQUk7SUFDdkIsb0JBQW9CLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNO0NBQzlDLENBQUE7QUFFRCxNQUFNLENBQUMsTUFBTSwyQkFBMkIsR0FBRyxJQUFJLENBQUM7QUFDaEQsZ0ZBQWdGO0FBQ2hGLE1BQU0sQ0FBQyxNQUFNLHNCQUFzQixHQUFHLHVCQUF1QixDQUFDO0FBQzlELE1BQU0sQ0FBQyxNQUFNLGlDQUFpQyxHQUFHLElBQUksQ0FBQztBQUV0RCxNQUFNLENBQU4sSUFBWSxvQkFNWDtBQU5ELFdBQVksb0JBQW9CO0lBQzlCLHFDQUFhLENBQUE7SUFDYixtQ0FBVyxDQUFBO0lBQ1gscUNBQWEsQ0FBQTtJQUNiLG1DQUFXLENBQUE7SUFDWCwyQ0FBbUIsQ0FBQTtBQUNyQixDQUFDLEVBTlcsb0JBQW9CLEtBQXBCLG9CQUFvQixRQU0vQjtBQUVELE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBNkI7SUFDdkQsZUFBZSxFQUFFLEtBQUs7SUFD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QjtZQUMvQix1QkFBdUI7WUFDdkIseURBQXlEO1lBQ3pELGlDQUFpQztZQUNqQywwQkFBMEI7WUFDMUIsY0FBYztZQUNkLHFDQUFxQztZQUNyQyxpR0FBaUc7WUFDakcsVUFBVTtZQUNWLFFBQVE7WUFDUixNQUFNO1lBQ04sMkJBQTJCO1lBQzNCLGtEQUFrRDtZQUNsRCwyQkFBMkI7WUFDM0IsUUFBUTtTQUNUO2FBQU07WUFDTCxJQUFJLENBQUMsWUFBWSxDQUFDLGlCQUFpQixHQUFHLEtBQUssQ0FBQztZQUM1QyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7U0FDckI7SUFDSCxDQUFDO0lBRU8sWUFBWTtRQUNsQixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVEOzs7O0tBSUM7SUFDTSxPQUFPLENBQUMsT0FBa0M7UUFDL0MsSUFBSSxPQUFPLEVBQUU7WUFDWCxJQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUM7U0FDOUQ7UUFDRCxJQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsZUFBZSxFQUFFO1lBQ3RDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1NBQzNCO1FBQ0QsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNsQyxDQUFDOzs4R0EzR1UsaUJBQWlCLDRDQVVrQiw2QkFBNkI7a0hBVmhFLGlCQUFpQixjQUZoQixNQUFNOzJGQUVQLGlCQUFpQjtrQkFIN0IsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQVd3QyxNQUFNOzJCQUFDLDZCQUE2Qjs7MEJBQUcsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE9uRGVzdHJveSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgZnJvbUV2ZW50LCBpbnRlcnZhbCwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzJztcbi8vIGltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5cbi8qKlxuICogSW5zdGFuY2Ugb2YgdGhpcyBpbnRlcmZhY2UgaXMgdXNlZCB0byByZXBvcnQgY3VycmVudCBjb25uZWN0aW9uIHN0YXR1cy5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0aW9uU3RhdGUge1xuICAvKipcbiAgICogXCJUcnVlXCIgaWYgYnJvd3NlciBoYXMgbmV0d29yayBjb25uZWN0aW9uLiBEZXRlcm1pbmVkIGJ5IFdpbmRvdyBvYmplY3RzIFwib25saW5lXCIgLyBcIm9mZmxpbmVcIiBldmVudHMuXG4gICAqL1xuICBoYXNOZXR3b3JrQ29ubmVjdGlvbjogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFwiVHJ1ZVwiIGlmIGJyb3dzZXIgaGFzIEludGVybmV0IGFjY2Vzcy4gRGV0ZXJtaW5lZCBieSBoZWFydGJlYXQgc3lzdGVtIHdoaWNoIHBlcmlvZGljYWxseSBtYWtlcyByZXF1ZXN0IHRvIGhlYXJ0YmVhdCBVcmwuXG4gICAqL1xuICBoYXNJbnRlcm5ldEFjY2VzczogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBJbnN0YW5jZSBvZiB0aGlzIGludGVyZmFjZSBjb3VsZCBiZSB1c2VkIHRvIGNvbmZpZ3VyZSBcIkNvbm5lY3Rpb25TZXJ2aWNlXCIuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ29ubmVjdGlvblNlcnZpY2VPcHRpb25zIHtcbiAgLyoqXG4gICAqIENvbnRyb2xzIHRoZSBJbnRlcm5ldCBjb25uZWN0aXZpdHkgaGVhcnRiZWF0IHN5c3RlbS4gRGVmYXVsdCB2YWx1ZSBpcyAndHJ1ZScuXG4gICAqL1xuICBlbmFibGVIZWFydGJlYXQ/OiBib29sZWFuO1xuICAvKipcbiAgICogVXJsIHVzZWQgZm9yIGNoZWNraW5nIEludGVybmV0IGNvbm5lY3Rpdml0eSwgaGVhcnRiZWF0IHN5c3RlbSBwZXJpb2RpY2FsbHkgbWFrZXMgXCJIRUFEXCIgcmVxdWVzdHMgdG8gdGhpcyBVUkwgdG8gZGV0ZXJtaW5lIEludGVybmV0XG4gICAqIGNvbm5lY3Rpb24gc3RhdHVzLiBEZWZhdWx0IHZhbHVlIGlzIFwiLy9pbnRlcm5ldGhlYWx0aHRlc3Qub3JnXCIuXG4gICAqL1xuICBoZWFydGJlYXRVcmw/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBJbnRlcnZhbCB1c2VkIHRvIGNoZWNrIEludGVybmV0IGNvbm5lY3Rpdml0eSBzcGVjaWZpZWQgaW4gbWlsbGlzZWNvbmRzLiBEZWZhdWx0IHZhbHVlIGlzIFwiMzAwMDBcIi5cbiAgICovXG4gIGhlYXJ0YmVhdEludGVydmFsPzogbnVtYmVyO1xuICAvKipcbiAgICogSW50ZXJ2YWwgdXNlZCB0byByZXRyeSBJbnRlcm5ldCBjb25uZWN0aXZpdHkgY2hlY2tzIHdoZW4gYW4gZXJyb3IgaXMgZGV0ZWN0ZWQgKHdoZW4gbm8gSW50ZXJuZXQgY29ubmVjdGlvbikuIERlZmF1bHQgdmFsdWUgaXMgXCIxMDAwXCIuXG4gICAqL1xuICBoZWFydGJlYXRSZXRyeUludGVydmFsPzogbnVtYmVyO1xuICAvKipcbiAgICogSFRUUCBtZXRob2QgdXNlZCBmb3IgcmVxdWVzdGluZyBoZWFydGJlYXQgVXJsLiBEZWZhdWx0IGlzICdoZWFkJy5cbiAgICovXG4gIHJlcXVlc3RNZXRob2Q/OiAnZ2V0JyB8ICdwb3N0JyB8ICdoZWFkJyB8ICdvcHRpb25zJztcblxufVxuXG4vKipcbiAqIEluamVjdGlvblRva2VuIGZvciBzcGVjaWZpbmcgQ29ubmVjdGlvblNlcnZpY2Ugb3B0aW9ucy5cbiAqL1xuZXhwb3J0IGNvbnN0IENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9uc1Rva2VuOiBJbmplY3Rpb25Ub2tlbjxDb25uZWN0aW9uU2VydmljZU9wdGlvbnM+ID0gbmV3IEluamVjdGlvblRva2VuKCdDb25uZWN0aW9uU2VydmljZU9wdGlvbnNUb2tlbicpO1xuXG5leHBvcnQgY29uc3QgREVGQVVMVF9DT05ORUNUSU9OX1NUQVRFOiBDb25uZWN0aW9uU3RhdGUgPSB7XG4gIGhhc0ludGVybmV0QWNjZXNzOiB0cnVlLFxuICBoYXNOZXR3b3JrQ29ubmVjdGlvbjogd2luZG93Lm5hdmlnYXRvci5vbkxpbmVcbn1cblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfSEVBUlRfQkVBVF9JTlRFUlZBTCA9IDEwMDA7XG4vLyBleHBvcnQgY29uc3QgREVGQVVMVF9IRUFSVF9CRUFUX1VSTCA9ICdodHRwczovL2pzb25wbGFjZWhvbGRlci50eXBpY29kZS5jb20nO1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfSEVBUlRfQkVBVF9VUkwgPSAnaHR0cDovL2xvY2FsaG9zdDozMDAwJztcbmV4cG9ydCBjb25zdCBERUZBVUxUX0hFQVJUX0JFQVRfUkVUUllfSU5URVJWQUwgPSAxMDAwO1xuXG5leHBvcnQgZW51bSBIVFRQX1JFUVVFU1RfTUVUSE9EUyB7XG4gIEhFQUQgPSAnaGVhZCcsXG4gIEdFVCA9ICdnZXQnLFxuICBQT1NUID0gJ3Bvc3QnLFxuICBQVVQgPSAncHV0JyxcbiAgT1BUSU9OUyA9ICdvcHRpb25zJ1xufVxuXG5leHBvcnQgY29uc3QgREVGQVVMVF9PUFRJT05TOiBDb25uZWN0aW9uU2VydmljZU9wdGlvbnMgPSB7XG4gIGVuYWJsZUhlYXJ0YmVhdDogZmFsc2UsXG4gIGhlYXJ0YmVhdFVybDogREVGQVVMVF9IRUFSVF9CRUFUX1VSTCxcbiAgaGVhcnRiZWF0SW50ZXJ2YWw6IERFRkFVTFRfSEVBUlRfQkVBVF9JTlRFUlZBTCxcbiAgaGVhcnRiZWF0UmV0cnlJbnRlcnZhbDogMTAwMCxcbiAgcmVxdWVzdE1ldGhvZDogSFRUUF9SRVFVRVNUX01FVEhPRFMuSEVBRFxufTtcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQ29ubmVjdGlvblNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuXG4gIHByaXZhdGUgY3VycmVudFN0YXRlOiBDb25uZWN0aW9uU3RhdGUgPSBERUZBVUxUX0NPTk5FQ1RJT05fU1RBVEU7XG4gIHByaXZhdGUgc2VydmljZU9wdGlvbnM6IENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucyA9IERFRkFVTFRfT1BUSU9OUztcblxuICBwcml2YXRlIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuICBwcml2YXRlIGh0dHBTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblxuICBwcml2YXRlIHN0YXRlQ2hhbmdlZCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PENvbm5lY3Rpb25TdGF0ZT4oREVGQVVMVF9DT05ORUNUSU9OX1NUQVRFKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIEBJbmplY3QoQ29ubmVjdGlvblNlcnZpY2VPcHRpb25zVG9rZW4pIEBPcHRpb25hbCgpIG9wdGlvbnM6IENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucykge1xuICAgIC8vIFRPRE86IFRva2VuIHVzZVZhbHVlIGluIHByb3ZpZGVycyBub3Qgd29ya2luZy5cbiAgICB0aGlzLnNlcnZpY2VPcHRpb25zID0geyAuLi5ERUZBVUxUX09QVElPTlMsIC4uLm9wdGlvbnMgfTtcbiAgICB0aGlzLmNoZWNrTmV0d29ya1N0YXRlKCk7XG5cbiAgICBpZiAodGhpcy5zZXJ2aWNlT3B0aW9ucy5lbmFibGVIZWFydGJlYXQpIHtcbiAgICAgIHRoaXMuY2hlY2tJbnRlcm5ldFN0YXRlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjaGVja05ldHdvcmtTdGF0ZSgpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQoZnJvbUV2ZW50KHdpbmRvdywgJ29ubGluZScpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5oYXNOZXR3b3JrQ29ubmVjdGlvbiA9IHRydWU7XG4gICAgICB0aGlzLmNoZWNrSW50ZXJuZXRTdGF0ZSgpO1xuICAgICAgdGhpcy5wdWJsaXNoU3RhdGUoKTtcbiAgICB9KSk7XG5cbiAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQoZnJvbUV2ZW50KHdpbmRvdywgJ29mZmxpbmUnKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5jdXJyZW50U3RhdGUuaGFzTmV0d29ya0Nvbm5lY3Rpb24gPSBmYWxzZTtcbiAgICAgIHRoaXMuY2hlY2tJbnRlcm5ldFN0YXRlKCk7XG4gICAgICB0aGlzLnB1Ymxpc2hTdGF0ZSgpO1xuICAgIH0pKTtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tJbnRlcm5ldFN0YXRlKCkge1xuXG4gICAgaWYgKHRoaXMuc2VydmljZU9wdGlvbnMuZW5hYmxlSGVhcnRiZWF0KSB7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IGludGVydmFsKDMwMDApLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcChhc3luYyAoKSA9PlxuICAgICAgICAgIHRoaXMuaHR0cFt0aGlzLnNlcnZpY2VPcHRpb25zLnJlcXVlc3RNZXRob2QgfHwgSFRUUF9SRVFVRVNUX01FVEhPRFMuSEVBRF0odGhpcy5zZXJ2aWNlT3B0aW9ucy5oZWFydGJlYXRVcmwgfHwgREVGQVVMVF9IRUFSVF9CRUFUX1VSTCxcbiAgICAgICAgICAgIHsgcmVzcG9uc2VUeXBlOiAndGV4dCcgfSkuc3Vic2NyaWJlKFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgbmV4dDogKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFN0YXRlLmhhc0ludGVybmV0QWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgIHRoaXMucHVibGlzaFN0YXRlKCk7XG4gICAgICAgICAgICAgICAgfSxcblxuICAgICAgICAgICAgICAgIGVycm9yOiAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5oYXNJbnRlcm5ldEFjY2VzcyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgdGhpcy5wdWJsaXNoU3RhdGUoKTtcbiAgICAgICAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICkuc3Vic2NyaWJlKFxuICAgICAgICByZXMgPT4ge1xuICAgICAgICB9XG4gICAgICApO1xuICAgICAgLy8gdGhpcy5odHRwU3Vic2NyaXB0aW9uID0gdGltZXIoMCwgdGhpcy5zZXJ2aWNlT3B0aW9ucy5oZWFydGJlYXRJbnRlcnZhbCB8fCBERUZBVUxUX0hFQVJUX0JFQVRfSU5URVJWQUwpXG4gICAgICAvLyAgIC5waXBlKFxuICAgICAgLy8gICAgIHN3aXRjaE1hcChhc3luYyAoKSA9PiB0aGlzLmh0dHBbdGhpcy5zZXJ2aWNlT3B0aW9ucy5yZXF1ZXN0TWV0aG9kIHx8IEhUVFBfUkVRVUVTVF9NRVRIT0RTLkhFQURdKHRoaXMuc2VydmljZU9wdGlvbnMuaGVhcnRiZWF0VXJsIHx8IERFRkFVTFRfSEVBUlRfQkVBVF9VUkwsXG4gICAgICAvLyAgICAgICB7IHJlc3BvbnNlVHlwZTogJ3RleHQnIH0pKSxcbiAgICAgIC8vICAgICByZXRyeVdoZW4oZXJyb3JzID0+XG4gICAgICAvLyAgICAgICBlcnJvcnMucGlwZShcbiAgICAgIC8vICAgICAgICAgLy8gbG9nIGVycm9yIG1lc3NhZ2VcbiAgICAgIC8vICAgICAgICAgdGFwKHZhbCA9PiB7XG4gICAgICAvLyAgICAgICAgICAgdGhpcy5jdXJyZW50U3RhdGUuaGFzSW50ZXJuZXRBY2Nlc3MgPSBmYWxzZTtcbiAgICAgIC8vICAgICAgICAgICB0aGlzLnB1Ymxpc2hTdGF0ZSgpO1xuICAgICAgLy8gICAgICAgICAgIHRocm93IGVycm9ycztcbiAgICAgIC8vICAgICAgICAgfSksXG4gICAgICAvLyAgICAgICAgIC8vIHJlc3RhcnQgYWZ0ZXIgNSBzZWNvbmRzXG4gICAgICAvLyAgICAgICAgIGRlbGF5KHRoaXMuc2VydmljZU9wdGlvbnMuaGVhcnRiZWF0UmV0cnlJbnRlcnZhbCB8fCBERUZBVUxUX0hFQVJUX0JFQVRfUkVUUllfSU5URVJWQUwpXG4gICAgICAvLyAgICAgICApXG4gICAgICAvLyAgICAgKVxuICAgICAgLy8gICApXG4gICAgICAvLyAgIC5zdWJzY3JpYmUocmVzdWx0ID0+IHtcbiAgICAgIC8vICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5oYXNJbnRlcm5ldEFjY2VzcyA9IHRydWU7XG4gICAgICAvLyAgICAgdGhpcy5wdWJsaXNoU3RhdGUoKTtcbiAgICAgIC8vICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3VycmVudFN0YXRlLmhhc0ludGVybmV0QWNjZXNzID0gZmFsc2U7XG4gICAgICB0aGlzLnB1Ymxpc2hTdGF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcHVibGlzaFN0YXRlKCkge1xuICAgIHRoaXMuc3RhdGVDaGFuZ2VkJC5uZXh0KHRoaXMuY3VycmVudFN0YXRlKTtcbiAgfVxuXG4gIC8qKlxuICogTW9uaXRvciBOZXR3b3JrICYgSW50ZXJuZXQgY29ubmVjdGlvbiBzdGF0dXMgYnkgc3Vic2NyaWJpbmcgdG8gdGhpcyBvYnNlcnZlci4gSWYgeW91IHNldCBcInJlcG9ydEN1cnJlbnRTdGF0ZVwiIHRvIFwiZmFsc2VcIiB0aGVuXG4gKiBmdW5jdGlvbiB3aWxsIG5vdCByZXBvcnQgY3VycmVudCBzdGF0dXMgb2YgdGhlIGNvbm5lY3Rpb25zIHdoZW4gaW5pdGlhbGx5IHN1YnNjcmliZWQuXG4gKiBAcGFyYW0gcmVwb3J0Q3VycmVudFN0YXRlIFJlcG9ydCBjdXJyZW50IHN0YXRlIHdoZW4gaW5pdGlhbCBzdWJzY3JpcHRpb24uIERlZmF1bHQgaXMgXCJ0cnVlXCJcbiAqL1xuICBwdWJsaWMgbW9uaXRvcihvcHRpb25zPzogQ29ubmVjdGlvblNlcnZpY2VPcHRpb25zKTogT2JzZXJ2YWJsZTxDb25uZWN0aW9uU3RhdGU+IHtcbiAgICBpZiAob3B0aW9ucykge1xuICAgICAgdGhpcy5zZXJ2aWNlT3B0aW9ucyA9IHsgLi4udGhpcy5zZXJ2aWNlT3B0aW9ucywgLi4ub3B0aW9ucyB9O1xuICAgIH1cbiAgICBpZih0aGlzLnNlcnZpY2VPcHRpb25zLmVuYWJsZUhlYXJ0YmVhdCkge1xuICAgICAgdGhpcy5jaGVja0ludGVybmV0U3RhdGUoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuc3RhdGVDaGFuZ2VkJDtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cbn1cbiJdfQ==