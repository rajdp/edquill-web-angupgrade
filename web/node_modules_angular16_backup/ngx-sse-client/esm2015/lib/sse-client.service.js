var SseClient_1;
import { __decorate } from "tslib";
import './events-polyfill';
import { HttpClient, HttpDownloadProgressEvent, HttpErrorResponse, HttpEvent, HttpEventType, HttpResponse } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import { delay, repeatWhen, retryWhen, takeWhile, tap } from 'rxjs/operators';
import { defaultSseOptions } from './sse-options.interface';
import { defaultRequestOptions } from './sse-request-options.interface';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
let SseClient = SseClient_1 = class SseClient {
    constructor(httpClient) {
        this.httpClient = httpClient;
        this.progress = 0;
        this.chunk = '';
    }
    stream(url, options, requestOptions, method = 'GET') {
        this.sseOptions = Object.assign({}, defaultSseOptions, options);
        this.httpClientOptions = Object.assign({}, requestOptions, defaultRequestOptions);
        return new Observable((observer) => {
            const subscription = this.subscribeStreamRequest(url, this.sseOptions, this.httpClientOptions, method, observer);
            return () => subscription.unsubscribe();
        });
    }
    subscribeStreamRequest(url, options, requestOptions, method, observer) {
        return this.httpClient
            .request(method, url, requestOptions)
            .pipe(repeatWhen((completed) => this.repeatWhen(completed, options.keepAlive, options.reconnectionDelay)))
            .pipe(retryWhen((error) => this.retryWhen(error, options.keepAlive, options.reconnectionDelay, observer)))
            .subscribe((event) => this.parseStreamEvent(event, observer));
    }
    repeatWhen(completed, keepAlive, reconnectionDelay) {
        return completed.pipe(takeWhile(() => keepAlive)).pipe(delay(reconnectionDelay));
    }
    retryWhen(attempts, keepAlive, reconnectionDelay, observer) {
        return attempts
            .pipe(tap((error) => this.threatRequestError(error, observer)))
            .pipe(takeWhile(() => keepAlive))
            .pipe(delay(reconnectionDelay));
    }
    threatRequestError(event, observer) {
        this.dispatchStreamData(this.errorEvent(event), observer);
        if (!this.isValidStatus(event.status)) {
            observer.error(event);
        }
    }
    isValidStatus(status) {
        return status !== undefined && status !== null && status <= 299;
    }
    parseStreamEvent(event, observer) {
        if (event.type === HttpEventType.Sent) {
            this.progress = 0;
            return;
        }
        if (event.type === HttpEventType.DownloadProgress) {
            this.onStreamProgress(event.partialText, observer);
            return;
        }
        if (event.type === HttpEventType.Response) {
            this.onStreamCompleted(event, observer);
            return;
        }
    }
    onStreamProgress(data, observer) {
        data = data.substring(this.progress);
        this.progress += data.length;
        data.split(/(\r\n|\r|\n){2}/g).forEach((part) => this.parseEventData(part, observer));
    }
    onStreamCompleted(response, observer) {
        this.onStreamProgress(response.body, observer);
        this.dispatchStreamData(this.parseEventChunk(this.chunk), observer);
        this.chunk = '';
        this.progress = 0;
        this.dispatchStreamData(this.errorEvent(), observer);
    }
    parseEventData(part, observer) {
        if (part.trim().length === 0) {
            this.dispatchStreamData(this.parseEventChunk(this.chunk), observer);
            this.chunk = '';
        }
        else {
            this.chunk += part;
        }
    }
    parseEventChunk(chunk) {
        if (!chunk || chunk.length === 0)
            return;
        const chunkEvent = { id: null, data: '', event: 'message' };
        chunk.split(/\n|\r\n|\r/).forEach((line) => this.parseChunkLine(line.trim(), chunkEvent));
        return this.messageEvent(chunkEvent.event, { lastEventId: chunkEvent.id, data: chunkEvent.data });
    }
    parseChunkLine(line, event) {
        const index = line.indexOf(SseClient_1.SEPARATOR);
        if (index <= 0)
            return null;
        const field = line.substring(0, index);
        if (Object.keys(event).findIndex((key) => key === field) === -1)
            return;
        let data = line.substring(index + 1);
        if (field === 'data')
            data = event.data + data;
        event[field] = data;
    }
    dispatchStreamData(event, observer) {
        if (!this.validEvent(event))
            return;
        if (this.sseOptions.responseType === 'event') {
            observer.next(event);
        }
        else {
            observer.next(event.data);
        }
    }
    validEvent(event) {
        if (!event)
            return false;
        if (event.type === 'error' && this.sseOptions.responseType !== 'event')
            return false;
        if (event.type !== 'error' && (!event.data || !event.data.length))
            return false;
        return true;
    }
    messageEvent(type, options) {
        return new MessageEvent(type, options);
    }
    errorEvent(error) {
        let eventInitDict;
        if (error && error.status > 0) {
            eventInitDict = { error, message: error.message };
            if (!this.isValidStatus(error.status)) {
                eventInitDict['status'] = error.status;
                eventInitDict['statusText'] = error.statusText;
            }
        }
        return new ErrorEvent('error', eventInitDict);
    }
};
SseClient.SEPARATOR = ':';
SseClient.ctorParameters = () => [
    { type: HttpClient }
];
SseClient.ɵprov = i0.ɵɵdefineInjectable({ factory: function SseClient_Factory() { return new SseClient(i0.ɵɵinject(i1.HttpClient)); }, token: SseClient, providedIn: "root" });
SseClient = SseClient_1 = __decorate([
    Injectable({
        providedIn: 'root',
    })
], SseClient);
export { SseClient };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3NlLWNsaWVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXNzZS1jbGllbnQvIiwic291cmNlcyI6WyJsaWIvc3NlLWNsaWVudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxtQkFBbUIsQ0FBQztBQUUzQixPQUFPLEVBQUUsVUFBVSxFQUFFLHlCQUF5QixFQUFFLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEksT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUE0QixNQUFNLE1BQU0sQ0FBQztBQUM1RCxPQUFPLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTlFLE9BQU8sRUFBRSxpQkFBaUIsRUFBYyxNQUFNLHlCQUF5QixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxxQkFBcUIsRUFBcUIsTUFBTSxpQ0FBaUMsQ0FBQzs7O0FBSzNGLElBQWEsU0FBUyxpQkFBdEIsTUFBYSxTQUFTO0lBU3BCLFlBQW9CLFVBQXNCO1FBQXRCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFObEMsYUFBUSxHQUFHLENBQUMsQ0FBQztRQUNiLFVBQUssR0FBRyxFQUFFLENBQUM7SUFLMEIsQ0FBQztJQTRCdkMsTUFBTSxDQUFDLEdBQVcsRUFBRSxPQUFvQixFQUFFLGNBQWtDLEVBQUUsTUFBTSxHQUFHLEtBQUs7UUFDakcsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxpQkFBaUIsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsaUJBQWlCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsY0FBcUIsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO1FBRXpGLE9BQU8sSUFBSSxVQUFVLENBQWlCLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDakQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDakgsT0FBTyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU8sc0JBQXNCLENBQUMsR0FBVyxFQUFFLE9BQW1CLEVBQUUsY0FBbUIsRUFBRSxNQUFjLEVBQUUsUUFBb0M7UUFDeEksT0FBTyxJQUFJLENBQUMsVUFBVTthQUNuQixPQUFPLENBQVMsTUFBTSxFQUFFLEdBQUcsRUFBRSxjQUFjLENBQUM7YUFDNUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO2FBQ3pHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLGlCQUFpQixFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7YUFDekcsU0FBUyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFDbEUsQ0FBQztJQUVPLFVBQVUsQ0FBQyxTQUEwQixFQUFFLFNBQWtCLEVBQUUsaUJBQXlCO1FBQzFGLE9BQU8sU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztJQUNuRixDQUFDO0lBRU8sU0FBUyxDQUFDLFFBQXlCLEVBQUUsU0FBa0IsRUFBRSxpQkFBeUIsRUFBRSxRQUFvQztRQUM5SCxPQUFPLFFBQVE7YUFDWixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7YUFDOUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUNoQyxJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRU8sa0JBQWtCLENBQUMsS0FBd0IsRUFBRSxRQUFvQztRQUN2RixJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUUxRCxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDckMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN2QjtJQUNILENBQUM7SUFFTyxhQUFhLENBQUMsTUFBYztRQUNsQyxPQUFPLE1BQU0sS0FBSyxTQUFTLElBQUksTUFBTSxLQUFLLElBQUksSUFBSSxNQUFNLElBQUksR0FBRyxDQUFDO0lBQ2xFLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxLQUF3QixFQUFFLFFBQTRCO1FBQzdFLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxhQUFhLENBQUMsSUFBSSxFQUFFO1lBQ3JDLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1lBQ2xCLE9BQU87U0FDUjtRQUVELElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxhQUFhLENBQUMsZ0JBQWdCLEVBQUU7WUFDakQsSUFBSSxDQUFDLGdCQUFnQixDQUFFLEtBQW1DLENBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ2xGLE9BQU87U0FDUjtRQUVELElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxhQUFhLENBQUMsUUFBUSxFQUFFO1lBQ3pDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUE2QixFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ2hFLE9BQU87U0FDUjtJQUNILENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxJQUFZLEVBQUUsUUFBNEI7UUFDakUsSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3JDLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ3hGLENBQUM7SUFFTyxpQkFBaUIsQ0FBQyxRQUE4QixFQUFFLFFBQTRCO1FBQ3BGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQy9DLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUVwRSxJQUFJLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQztRQUVsQixJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFTyxjQUFjLENBQUMsSUFBWSxFQUFFLFFBQTRCO1FBQy9ELElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDNUIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ3BFLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1NBQ2pCO2FBQU07WUFDTCxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQztTQUNwQjtJQUNILENBQUM7SUFFTyxlQUFlLENBQUMsS0FBYTtRQUNuQyxJQUFJLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQztZQUFFLE9BQU87UUFFekMsTUFBTSxVQUFVLEdBQWUsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUFDO1FBQ3hFLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBRTFGLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLEVBQUUsV0FBVyxFQUFFLFVBQVUsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3BHLENBQUM7SUFFTyxjQUFjLENBQUMsSUFBWSxFQUFFLEtBQWlCO1FBQ3BELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2hELElBQUksS0FBSyxJQUFJLENBQUM7WUFBRSxPQUFPLElBQUksQ0FBQztRQUU1QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN2QyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBVyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEtBQUssS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQUUsT0FBTztRQUVoRixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNyQyxJQUFJLEtBQUssS0FBSyxNQUFNO1lBQUUsSUFBSSxHQUFHLEtBQUssQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBRS9DLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDdEIsQ0FBQztJQUVPLGtCQUFrQixDQUFDLEtBQVksRUFBRSxRQUE2QjtRQUNwRSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUM7WUFBRSxPQUFPO1FBRXBDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEtBQUssT0FBTyxFQUFFO1lBQzVDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDdEI7YUFBTTtZQUNMLFFBQVEsQ0FBQyxJQUFJLENBQUUsS0FBc0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM3QztJQUNILENBQUM7SUFFTyxVQUFVLENBQUMsS0FBWTtRQUM3QixJQUFJLENBQUMsS0FBSztZQUFFLE9BQU8sS0FBSyxDQUFDO1FBQ3pCLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxPQUFPLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEtBQUssT0FBTztZQUFFLE9BQU8sS0FBSyxDQUFDO1FBQ3JGLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxPQUFPLElBQUksQ0FBQyxDQUFFLEtBQXNCLENBQUMsSUFBSSxJQUFJLENBQUUsS0FBc0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFDcEgsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU8sWUFBWSxDQUFDLElBQVksRUFBRSxPQUF5QjtRQUMxRCxPQUFPLElBQUksWUFBWSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRU8sVUFBVSxDQUFDLEtBQVc7UUFDNUIsSUFBSSxhQUE2QixDQUFDO1FBRWxDLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzdCLGFBQWEsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBRWxELElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDckMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7Z0JBQ3ZDLGFBQWEsQ0FBQyxZQUFZLENBQUMsR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFDO2FBQ2hEO1NBQ0Y7UUFFRCxPQUFPLElBQUksVUFBVSxDQUFDLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztJQUNoRCxDQUFDO0NBQ0YsQ0FBQTtBQWhMeUIsbUJBQVMsR0FBRyxHQUFHLENBQUM7O1lBUVIsVUFBVTs7O0FBVC9CLFNBQVM7SUFIckIsVUFBVSxDQUFDO1FBQ1YsVUFBVSxFQUFFLE1BQU07S0FDbkIsQ0FBQztHQUNXLFNBQVMsQ0FpTHJCO1NBakxZLFNBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJy4vZXZlbnRzLXBvbHlmaWxsJztcblxuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cERvd25sb2FkUHJvZ3Jlc3NFdmVudCwgSHR0cEVycm9yUmVzcG9uc2UsIEh0dHBFdmVudCwgSHR0cEV2ZW50VHlwZSwgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3Vic2NyaWJlciwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWxheSwgcmVwZWF0V2hlbiwgcmV0cnlXaGVuLCB0YWtlV2hpbGUsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgZGVmYXVsdFNzZU9wdGlvbnMsIFNzZU9wdGlvbnMgfSBmcm9tICcuL3NzZS1vcHRpb25zLmludGVyZmFjZSc7XG5pbXBvcnQgeyBkZWZhdWx0UmVxdWVzdE9wdGlvbnMsIFNzZVJlcXVlc3RPcHRpb25zIH0gZnJvbSAnLi9zc2UtcmVxdWVzdC1vcHRpb25zLmludGVyZmFjZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBTc2VDbGllbnQge1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBTRVBBUkFUT1IgPSAnOic7XG5cbiAgcHJpdmF0ZSBwcm9ncmVzcyA9IDA7XG4gIHByaXZhdGUgY2h1bmsgPSAnJztcblxuICBwcml2YXRlIHNzZU9wdGlvbnM6IFNzZU9wdGlvbnM7XG4gIHByaXZhdGUgaHR0cENsaWVudE9wdGlvbnM6IGFueTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQpIHt9XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgYSByZXF1ZXN0IHdoaWNoIGxpc3RlbiB0byB0aGUgU1NFIGFuZCBpbnRlcnByZXRzIHRoZSBkYXRhIGFzXG4gICAqIGV2ZW50cyBhbmQgcmV0dXJucyB0aGUgZnVsbCBldmVudCBzdHJlYW0uXG4gICAqXG4gICAqIEBwYXJhbSB1cmwgdGhlIGVuZHBvaW50IFVSTC5cbiAgICogQHBhcmFtIG9wdGlvbnMgYW4gb2JqZWN0IG9mIGBTc2VPcHRpb25gXG4gICAqIEBwYXJhbSByZXF1ZXN0T3B0aW9ucyB0aGUgSFRUUCBvcHRpb25zIHRvIHNlbmQgd2l0aCB0aGUgcmVxdWVzdC5cbiAgICogQHBhcmFtIG1ldGhvZCB0aGUgSFRUUCBtZXRob2RcbiAgICpcbiAgICogQHJldHVybnMgYW4gb2JzZXJ2YWJsZSBvZiBhbGwgZXZlbnRzIGZvciB0aGUgcmVxdWVzdCwgd2l0aCB0aGUgcmVzcG9uc2UgYm9keSBvZiB0eXBlIGBFdmVudGAuXG4gICAqL1xuICBwdWJsaWMgc3RyZWFtKHVybDogc3RyaW5nLCBvcHRpb25zPzogeyBrZWVwQWxpdmU/OiBib29sZWFuOyByZWNvbm5lY3Rpb25EZWxheT86IG51bWJlcjsgcmVzcG9uc2VUeXBlPzogJ2V2ZW50JyB9LCByZXF1ZXN0T3B0aW9ucz86IFNzZVJlcXVlc3RPcHRpb25zLCBtZXRob2Q/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPEV2ZW50PjtcblxuICAvKipcbiAgICogQ29uc3RydWN0cyBhIHJlcXVlc3Qgd2hpY2ggbGlzdGVuIHRvIHRoZSBTU0UgYW5kIGludGVycHJldHMgdGhlIGRhdGEgYXMgYVxuICAgKiBzdHJpbmcgdGV4dCBhbmQgcmV0dXJucyB0aGUgZnVsbCBldmVudCBzdHJlYW0uXG4gICAqXG4gICAqIEBwYXJhbSB1cmwgdGhlIGVuZHBvaW50IFVSTC5cbiAgICogQHBhcmFtIG9wdGlvbnMgYW4gb2JqZWN0IG9mIGBTc2VPcHRpb25gXG4gICAqIEBwYXJhbSByZXF1ZXN0T3B0aW9ucyB0aGUgSFRUUCBvcHRpb25zIHRvIHNlbmQgd2l0aCB0aGUgcmVxdWVzdC5cbiAgICogQHBhcmFtIG1ldGhvZCB0aGUgSFRUUCBtZXRob2RcbiAgICpcbiAgICogQHJldHVybnMgYW4gb2JzZXJ2YWJsZSBvZiBhbGwgZXZlbnRzIGZvciB0aGUgcmVxdWVzdCwgd2l0aCB0aGUgcmVzcG9uc2UgYm9keSBvZiB0eXBlIHN0cmluZy5cbiAgICovXG4gIHB1YmxpYyBzdHJlYW0odXJsOiBzdHJpbmcsIG9wdGlvbnM/OiB7IGtlZXBBbGl2ZT86IGJvb2xlYW47IHJlY29ubmVjdGlvbkRlbGF5PzogbnVtYmVyOyByZXNwb25zZVR5cGU/OiAndGV4dCcgfSwgcmVxdWVzdE9wdGlvbnM/OiBTc2VSZXF1ZXN0T3B0aW9ucywgbWV0aG9kPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+O1xuXG4gIHB1YmxpYyBzdHJlYW0odXJsOiBzdHJpbmcsIG9wdGlvbnM/OiBTc2VPcHRpb25zLCByZXF1ZXN0T3B0aW9ucz86IFNzZVJlcXVlc3RPcHRpb25zLCBtZXRob2QgPSAnR0VUJyk6IE9ic2VydmFibGU8c3RyaW5nIHwgRXZlbnQ+IHtcbiAgICB0aGlzLnNzZU9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0U3NlT3B0aW9ucywgb3B0aW9ucyk7XG4gICAgdGhpcy5odHRwQ2xpZW50T3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIHJlcXVlc3RPcHRpb25zIGFzIGFueSwgZGVmYXVsdFJlcXVlc3RPcHRpb25zKTtcblxuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZTxzdHJpbmcgfCBFdmVudD4oKG9ic2VydmVyKSA9PiB7XG4gICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLnN1YnNjcmliZVN0cmVhbVJlcXVlc3QodXJsLCB0aGlzLnNzZU9wdGlvbnMsIHRoaXMuaHR0cENsaWVudE9wdGlvbnMsIG1ldGhvZCwgb2JzZXJ2ZXIpO1xuICAgICAgcmV0dXJuICgpID0+IHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpYmVTdHJlYW1SZXF1ZXN0KHVybDogc3RyaW5nLCBvcHRpb25zOiBTc2VPcHRpb25zLCByZXF1ZXN0T3B0aW9uczogYW55LCBtZXRob2Q6IHN0cmluZywgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8c3RyaW5nIHwgRXZlbnQ+KTogU3Vic2NyaXB0aW9uIHtcbiAgICByZXR1cm4gdGhpcy5odHRwQ2xpZW50XG4gICAgICAucmVxdWVzdDxzdHJpbmc+KG1ldGhvZCwgdXJsLCByZXF1ZXN0T3B0aW9ucylcbiAgICAgIC5waXBlKHJlcGVhdFdoZW4oKGNvbXBsZXRlZCkgPT4gdGhpcy5yZXBlYXRXaGVuKGNvbXBsZXRlZCwgb3B0aW9ucy5rZWVwQWxpdmUsIG9wdGlvbnMucmVjb25uZWN0aW9uRGVsYXkpKSlcbiAgICAgIC5waXBlKHJldHJ5V2hlbigoZXJyb3IpID0+IHRoaXMucmV0cnlXaGVuKGVycm9yLCBvcHRpb25zLmtlZXBBbGl2ZSwgb3B0aW9ucy5yZWNvbm5lY3Rpb25EZWxheSwgb2JzZXJ2ZXIpKSlcbiAgICAgIC5zdWJzY3JpYmUoKGV2ZW50KSA9PiB0aGlzLnBhcnNlU3RyZWFtRXZlbnQoZXZlbnQsIG9ic2VydmVyKSk7XG4gIH1cblxuICBwcml2YXRlIHJlcGVhdFdoZW4oY29tcGxldGVkOiBPYnNlcnZhYmxlPGFueT4sIGtlZXBBbGl2ZTogYm9vbGVhbiwgcmVjb25uZWN0aW9uRGVsYXk6IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIGNvbXBsZXRlZC5waXBlKHRha2VXaGlsZSgoKSA9PiBrZWVwQWxpdmUpKS5waXBlKGRlbGF5KHJlY29ubmVjdGlvbkRlbGF5KSk7XG4gIH1cblxuICBwcml2YXRlIHJldHJ5V2hlbihhdHRlbXB0czogT2JzZXJ2YWJsZTxhbnk+LCBrZWVwQWxpdmU6IGJvb2xlYW4sIHJlY29ubmVjdGlvbkRlbGF5OiBudW1iZXIsIG9ic2VydmVyOiBTdWJzY3JpYmVyPHN0cmluZyB8IEV2ZW50Pik6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIGF0dGVtcHRzXG4gICAgICAucGlwZSh0YXAoKGVycm9yKSA9PiB0aGlzLnRocmVhdFJlcXVlc3RFcnJvcihlcnJvciwgb2JzZXJ2ZXIpKSlcbiAgICAgIC5waXBlKHRha2VXaGlsZSgoKSA9PiBrZWVwQWxpdmUpKVxuICAgICAgLnBpcGUoZGVsYXkocmVjb25uZWN0aW9uRGVsYXkpKTtcbiAgfVxuXG4gIHByaXZhdGUgdGhyZWF0UmVxdWVzdEVycm9yKGV2ZW50OiBIdHRwRXJyb3JSZXNwb25zZSwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8c3RyaW5nIHwgRXZlbnQ+KTogdm9pZCB7XG4gICAgdGhpcy5kaXNwYXRjaFN0cmVhbURhdGEodGhpcy5lcnJvckV2ZW50KGV2ZW50KSwgb2JzZXJ2ZXIpO1xuXG4gICAgaWYgKCF0aGlzLmlzVmFsaWRTdGF0dXMoZXZlbnQuc3RhdHVzKSkge1xuICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXZlbnQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNWYWxpZFN0YXR1cyhzdGF0dXM6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzdGF0dXMgIT09IHVuZGVmaW5lZCAmJiBzdGF0dXMgIT09IG51bGwgJiYgc3RhdHVzIDw9IDI5OTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VTdHJlYW1FdmVudChldmVudDogSHR0cEV2ZW50PHN0cmluZz4sIG9ic2VydmVyOiBTdWJzY3JpYmVyPHN0cmluZz4pOiB2b2lkIHtcbiAgICBpZiAoZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5TZW50KSB7XG4gICAgICB0aGlzLnByb2dyZXNzID0gMDtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoZXZlbnQudHlwZSA9PT0gSHR0cEV2ZW50VHlwZS5Eb3dubG9hZFByb2dyZXNzKSB7XG4gICAgICB0aGlzLm9uU3RyZWFtUHJvZ3Jlc3MoKGV2ZW50IGFzIEh0dHBEb3dubG9hZFByb2dyZXNzRXZlbnQpLnBhcnRpYWxUZXh0LCBvYnNlcnZlcik7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGV2ZW50LnR5cGUgPT09IEh0dHBFdmVudFR5cGUuUmVzcG9uc2UpIHtcbiAgICAgIHRoaXMub25TdHJlYW1Db21wbGV0ZWQoZXZlbnQgYXMgSHR0cFJlc3BvbnNlPHN0cmluZz4sIG9ic2VydmVyKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uU3RyZWFtUHJvZ3Jlc3MoZGF0YTogc3RyaW5nLCBvYnNlcnZlcjogU3Vic2NyaWJlcjxzdHJpbmc+KTogdm9pZCB7XG4gICAgZGF0YSA9IGRhdGEuc3Vic3RyaW5nKHRoaXMucHJvZ3Jlc3MpO1xuICAgIHRoaXMucHJvZ3Jlc3MgKz0gZGF0YS5sZW5ndGg7XG4gICAgZGF0YS5zcGxpdCgvKFxcclxcbnxcXHJ8XFxuKXsyfS9nKS5mb3JFYWNoKChwYXJ0KSA9PiB0aGlzLnBhcnNlRXZlbnREYXRhKHBhcnQsIG9ic2VydmVyKSk7XG4gIH1cblxuICBwcml2YXRlIG9uU3RyZWFtQ29tcGxldGVkKHJlc3BvbnNlOiBIdHRwUmVzcG9uc2U8c3RyaW5nPiwgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8c3RyaW5nPik6IHZvaWQge1xuICAgIHRoaXMub25TdHJlYW1Qcm9ncmVzcyhyZXNwb25zZS5ib2R5LCBvYnNlcnZlcik7XG4gICAgdGhpcy5kaXNwYXRjaFN0cmVhbURhdGEodGhpcy5wYXJzZUV2ZW50Q2h1bmsodGhpcy5jaHVuayksIG9ic2VydmVyKTtcblxuICAgIHRoaXMuY2h1bmsgPSAnJztcbiAgICB0aGlzLnByb2dyZXNzID0gMDtcblxuICAgIHRoaXMuZGlzcGF0Y2hTdHJlYW1EYXRhKHRoaXMuZXJyb3JFdmVudCgpLCBvYnNlcnZlcik7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlRXZlbnREYXRhKHBhcnQ6IHN0cmluZywgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8c3RyaW5nPikge1xuICAgIGlmIChwYXJ0LnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMuZGlzcGF0Y2hTdHJlYW1EYXRhKHRoaXMucGFyc2VFdmVudENodW5rKHRoaXMuY2h1bmspLCBvYnNlcnZlcik7XG4gICAgICB0aGlzLmNodW5rID0gJyc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2h1bmsgKz0gcGFydDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHBhcnNlRXZlbnRDaHVuayhjaHVuazogc3RyaW5nKTogTWVzc2FnZUV2ZW50IHtcbiAgICBpZiAoIWNodW5rIHx8IGNodW5rLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuXG4gICAgY29uc3QgY2h1bmtFdmVudDogQ2h1bmtFdmVudCA9IHsgaWQ6IG51bGwsIGRhdGE6ICcnLCBldmVudDogJ21lc3NhZ2UnIH07XG4gICAgY2h1bmsuc3BsaXQoL1xcbnxcXHJcXG58XFxyLykuZm9yRWFjaCgobGluZSkgPT4gdGhpcy5wYXJzZUNodW5rTGluZShsaW5lLnRyaW0oKSwgY2h1bmtFdmVudCkpO1xuXG4gICAgcmV0dXJuIHRoaXMubWVzc2FnZUV2ZW50KGNodW5rRXZlbnQuZXZlbnQsIHsgbGFzdEV2ZW50SWQ6IGNodW5rRXZlbnQuaWQsIGRhdGE6IGNodW5rRXZlbnQuZGF0YSB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VDaHVua0xpbmUobGluZTogc3RyaW5nLCBldmVudDogQ2h1bmtFdmVudCk6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gbGluZS5pbmRleE9mKFNzZUNsaWVudC5TRVBBUkFUT1IpO1xuICAgIGlmIChpbmRleCA8PSAwKSByZXR1cm4gbnVsbDtcblxuICAgIGNvbnN0IGZpZWxkID0gbGluZS5zdWJzdHJpbmcoMCwgaW5kZXgpO1xuICAgIGlmIChPYmplY3Qua2V5cyhldmVudCkuZmluZEluZGV4KChrZXk6IHN0cmluZykgPT4ga2V5ID09PSBmaWVsZCkgPT09IC0xKSByZXR1cm47XG5cbiAgICBsZXQgZGF0YSA9IGxpbmUuc3Vic3RyaW5nKGluZGV4ICsgMSk7XG4gICAgaWYgKGZpZWxkID09PSAnZGF0YScpIGRhdGEgPSBldmVudC5kYXRhICsgZGF0YTtcblxuICAgIGV2ZW50W2ZpZWxkXSA9IGRhdGE7XG4gIH1cblxuICBwcml2YXRlIGRpc3BhdGNoU3RyZWFtRGF0YShldmVudDogRXZlbnQsIG9ic2VydmVyOiBTdWJzY3JpYmVyPHVua25vd24+KTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnZhbGlkRXZlbnQoZXZlbnQpKSByZXR1cm47XG5cbiAgICBpZiAodGhpcy5zc2VPcHRpb25zLnJlc3BvbnNlVHlwZSA9PT0gJ2V2ZW50Jykge1xuICAgICAgb2JzZXJ2ZXIubmV4dChldmVudCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG9ic2VydmVyLm5leHQoKGV2ZW50IGFzIE1lc3NhZ2VFdmVudCkuZGF0YSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZEV2ZW50KGV2ZW50OiBFdmVudCk6IGJvb2xlYW4ge1xuICAgIGlmICghZXZlbnQpIHJldHVybiBmYWxzZTtcbiAgICBpZiAoZXZlbnQudHlwZSA9PT0gJ2Vycm9yJyAmJiB0aGlzLnNzZU9wdGlvbnMucmVzcG9uc2VUeXBlICE9PSAnZXZlbnQnKSByZXR1cm4gZmFsc2U7XG4gICAgaWYgKGV2ZW50LnR5cGUgIT09ICdlcnJvcicgJiYgKCEoZXZlbnQgYXMgTWVzc2FnZUV2ZW50KS5kYXRhIHx8ICEoZXZlbnQgYXMgTWVzc2FnZUV2ZW50KS5kYXRhLmxlbmd0aCkpIHJldHVybiBmYWxzZTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHByaXZhdGUgbWVzc2FnZUV2ZW50KHR5cGU6IHN0cmluZywgb3B0aW9uczogTWVzc2FnZUV2ZW50SW5pdCk6IE1lc3NhZ2VFdmVudCB7XG4gICAgcmV0dXJuIG5ldyBNZXNzYWdlRXZlbnQodHlwZSwgb3B0aW9ucyk7XG4gIH1cblxuICBwcml2YXRlIGVycm9yRXZlbnQoZXJyb3I/OiBhbnkpOiBFdmVudCB7XG4gICAgbGV0IGV2ZW50SW5pdERpY3Q6IEVycm9yRXZlbnRJbml0O1xuXG4gICAgaWYgKGVycm9yICYmIGVycm9yLnN0YXR1cyA+IDApIHtcbiAgICAgIGV2ZW50SW5pdERpY3QgPSB7IGVycm9yLCBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIH07XG5cbiAgICAgIGlmICghdGhpcy5pc1ZhbGlkU3RhdHVzKGVycm9yLnN0YXR1cykpIHtcbiAgICAgICAgZXZlbnRJbml0RGljdFsnc3RhdHVzJ10gPSBlcnJvci5zdGF0dXM7XG4gICAgICAgIGV2ZW50SW5pdERpY3RbJ3N0YXR1c1RleHQnXSA9IGVycm9yLnN0YXR1c1RleHQ7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBFcnJvckV2ZW50KCdlcnJvcicsIGV2ZW50SW5pdERpY3QpO1xuICB9XG59XG5cbnR5cGUgQ2h1bmtFdmVudCA9IHsgaWQ6IHN0cmluZzsgZGF0YTogc3RyaW5nOyBldmVudDogJ21lc3NhZ2UnIH07XG4iXX0=