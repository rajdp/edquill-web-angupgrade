import { __decorate } from "tslib";
import './events-polyfill';
import { HttpClient, HttpDownloadProgressEvent, HttpErrorResponse, HttpEvent, HttpEventType, HttpResponse } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { Observable } from 'rxjs';
import { delay, repeatWhen, retryWhen, takeWhile, tap } from 'rxjs/operators';
import { defaultSseOptions } from './sse-options.interface';
import { defaultRequestOptions } from './sse-request-options.interface';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
var SseClient = /** @class */ (function () {
    function SseClient(httpClient) {
        this.httpClient = httpClient;
        this.progress = 0;
        this.chunk = '';
    }
    SseClient_1 = SseClient;
    SseClient.prototype.stream = function (url, options, requestOptions, method) {
        var _this = this;
        if (method === void 0) { method = 'GET'; }
        this.sseOptions = Object.assign({}, defaultSseOptions, options);
        this.httpClientOptions = Object.assign({}, requestOptions, defaultRequestOptions);
        return new Observable(function (observer) {
            var subscription = _this.subscribeStreamRequest(url, _this.sseOptions, _this.httpClientOptions, method, observer);
            return function () { return subscription.unsubscribe(); };
        });
    };
    SseClient.prototype.subscribeStreamRequest = function (url, options, requestOptions, method, observer) {
        var _this = this;
        return this.httpClient
            .request(method, url, requestOptions)
            .pipe(repeatWhen(function (completed) { return _this.repeatWhen(completed, options.keepAlive, options.reconnectionDelay); }))
            .pipe(retryWhen(function (error) { return _this.retryWhen(error, options.keepAlive, options.reconnectionDelay, observer); }))
            .subscribe(function (event) { return _this.parseStreamEvent(event, observer); });
    };
    SseClient.prototype.repeatWhen = function (completed, keepAlive, reconnectionDelay) {
        return completed.pipe(takeWhile(function () { return keepAlive; })).pipe(delay(reconnectionDelay));
    };
    SseClient.prototype.retryWhen = function (attempts, keepAlive, reconnectionDelay, observer) {
        var _this = this;
        return attempts
            .pipe(tap(function (error) { return _this.threatRequestError(error, observer); }))
            .pipe(takeWhile(function () { return keepAlive; }))
            .pipe(delay(reconnectionDelay));
    };
    SseClient.prototype.threatRequestError = function (event, observer) {
        this.dispatchStreamData(this.errorEvent(event), observer);
        if (!this.isValidStatus(event.status)) {
            observer.error(event);
        }
    };
    SseClient.prototype.isValidStatus = function (status) {
        return status !== undefined && status !== null && status <= 299;
    };
    SseClient.prototype.parseStreamEvent = function (event, observer) {
        if (event.type === HttpEventType.Sent) {
            this.progress = 0;
            return;
        }
        if (event.type === HttpEventType.DownloadProgress) {
            this.onStreamProgress(event.partialText, observer);
            return;
        }
        if (event.type === HttpEventType.Response) {
            this.onStreamCompleted(event, observer);
            return;
        }
    };
    SseClient.prototype.onStreamProgress = function (data, observer) {
        var _this = this;
        data = data.substring(this.progress);
        this.progress += data.length;
        data.split(/(\r\n|\r|\n){2}/g).forEach(function (part) { return _this.parseEventData(part, observer); });
    };
    SseClient.prototype.onStreamCompleted = function (response, observer) {
        this.onStreamProgress(response.body, observer);
        this.dispatchStreamData(this.parseEventChunk(this.chunk), observer);
        this.chunk = '';
        this.progress = 0;
        this.dispatchStreamData(this.errorEvent(), observer);
    };
    SseClient.prototype.parseEventData = function (part, observer) {
        if (part.trim().length === 0) {
            this.dispatchStreamData(this.parseEventChunk(this.chunk), observer);
            this.chunk = '';
        }
        else {
            this.chunk += part;
        }
    };
    SseClient.prototype.parseEventChunk = function (chunk) {
        var _this = this;
        if (!chunk || chunk.length === 0)
            return;
        var chunkEvent = { id: null, data: '', event: 'message' };
        chunk.split(/\n|\r\n|\r/).forEach(function (line) { return _this.parseChunkLine(line.trim(), chunkEvent); });
        return this.messageEvent(chunkEvent.event, { lastEventId: chunkEvent.id, data: chunkEvent.data });
    };
    SseClient.prototype.parseChunkLine = function (line, event) {
        var index = line.indexOf(SseClient_1.SEPARATOR);
        if (index <= 0)
            return null;
        var field = line.substring(0, index);
        if (Object.keys(event).findIndex(function (key) { return key === field; }) === -1)
            return;
        var data = line.substring(index + 1);
        if (field === 'data')
            data = event.data + data;
        event[field] = data;
    };
    SseClient.prototype.dispatchStreamData = function (event, observer) {
        if (!this.validEvent(event))
            return;
        if (this.sseOptions.responseType === 'event') {
            observer.next(event);
        }
        else {
            observer.next(event.data);
        }
    };
    SseClient.prototype.validEvent = function (event) {
        if (!event)
            return false;
        if (event.type === 'error' && this.sseOptions.responseType !== 'event')
            return false;
        if (event.type !== 'error' && (!event.data || !event.data.length))
            return false;
        return true;
    };
    SseClient.prototype.messageEvent = function (type, options) {
        return new MessageEvent(type, options);
    };
    SseClient.prototype.errorEvent = function (error) {
        var eventInitDict;
        if (error && error.status > 0) {
            eventInitDict = { error: error, message: error.message };
            if (!this.isValidStatus(error.status)) {
                eventInitDict['status'] = error.status;
                eventInitDict['statusText'] = error.statusText;
            }
        }
        return new ErrorEvent('error', eventInitDict);
    };
    var SseClient_1;
    SseClient.SEPARATOR = ':';
    SseClient.ctorParameters = function () { return [
        { type: HttpClient }
    ]; };
    SseClient.ɵprov = i0.ɵɵdefineInjectable({ factory: function SseClient_Factory() { return new SseClient(i0.ɵɵinject(i1.HttpClient)); }, token: SseClient, providedIn: "root" });
    SseClient = SseClient_1 = __decorate([
        Injectable({
            providedIn: 'root',
        })
    ], SseClient);
    return SseClient;
}());
export { SseClient };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3NlLWNsaWVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LXNzZS1jbGllbnQvIiwic291cmNlcyI6WyJsaWIvc3NlLWNsaWVudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLG1CQUFtQixDQUFDO0FBRTNCLE9BQU8sRUFBRSxVQUFVLEVBQUUseUJBQXlCLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4SSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQTRCLE1BQU0sTUFBTSxDQUFDO0FBQzVELE9BQU8sRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFOUUsT0FBTyxFQUFFLGlCQUFpQixFQUFjLE1BQU0seUJBQXlCLENBQUM7QUFDeEUsT0FBTyxFQUFFLHFCQUFxQixFQUFxQixNQUFNLGlDQUFpQyxDQUFDOzs7QUFLM0Y7SUFTRSxtQkFBb0IsVUFBc0I7UUFBdEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQU5sQyxhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2IsVUFBSyxHQUFHLEVBQUUsQ0FBQztJQUswQixDQUFDO2tCQVRuQyxTQUFTO0lBcUNiLDBCQUFNLEdBQWIsVUFBYyxHQUFXLEVBQUUsT0FBb0IsRUFBRSxjQUFrQyxFQUFFLE1BQWM7UUFBbkcsaUJBUUM7UUFSb0YsdUJBQUEsRUFBQSxjQUFjO1FBQ2pHLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLGNBQXFCLEVBQUUscUJBQXFCLENB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QyxJQUFJLElBQUksQ0FBRSxLQUFzQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7WUFBRSxPQUFPLEtBQUssQ0FBQztRQUNwSCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTyxnQ0FBWSxHQUFwQixVQUFxQixJQUFZLEVBQUUsT0FBeUI7UUFDMUQsT0FBTyxJQUFJLFlBQVksQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVPLDhCQUFVLEdBQWxCLFVBQW1CLEtBQVc7UUFDNUIsSUFBSSxhQUE2QixDQUFDO1FBRWxDLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzdCLGFBQWEsR0FBRyxFQUFFLEtBQUssT0FBQSxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7WUFFbEQsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUNyQyxhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztnQkFDdkMsYUFBYSxDQUFDLFlBQVksQ0FBQyxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUM7YUFDaEQ7U0FDRjtRQUVELE9BQU8sSUFBSSxVQUFVLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQ2hELENBQUM7O0lBL0t1QixtQkFBUyxHQUFHLEdBQUcsQ0FBQzs7Z0JBUVIsVUFBVTs7O0lBVC9CLFNBQVM7UUFIckIsVUFBVSxDQUFDO1lBQ1YsVUFBVSxFQUFFLE1BQU07U0FDbkIsQ0FBQztPQUNXLFNBQVMsQ0FpTHJCO29CQTlMRDtDQThMQyxBQWpMRCxJQWlMQztTQWpMWSxTQUFTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICcuL2V2ZW50cy1wb2x5ZmlsbCc7XG5cbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBEb3dubG9hZFByb2dyZXNzRXZlbnQsIEh0dHBFcnJvclJlc3BvbnNlLCBIdHRwRXZlbnQsIEh0dHBFdmVudFR5cGUsIEh0dHBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmliZXIsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVsYXksIHJlcGVhdFdoZW4sIHJldHJ5V2hlbiwgdGFrZVdoaWxlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IGRlZmF1bHRTc2VPcHRpb25zLCBTc2VPcHRpb25zIH0gZnJvbSAnLi9zc2Utb3B0aW9ucy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgZGVmYXVsdFJlcXVlc3RPcHRpb25zLCBTc2VSZXF1ZXN0T3B0aW9ucyB9IGZyb20gJy4vc3NlLXJlcXVlc3Qtb3B0aW9ucy5pbnRlcmZhY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgU3NlQ2xpZW50IHtcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgU0VQQVJBVE9SID0gJzonO1xuXG4gIHByaXZhdGUgcHJvZ3Jlc3MgPSAwO1xuICBwcml2YXRlIGNodW5rID0gJyc7XG5cbiAgcHJpdmF0ZSBzc2VPcHRpb25zOiBTc2VPcHRpb25zO1xuICBwcml2YXRlIGh0dHBDbGllbnRPcHRpb25zOiBhbnk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50KSB7fVxuXG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIGEgcmVxdWVzdCB3aGljaCBsaXN0ZW4gdG8gdGhlIFNTRSBhbmQgaW50ZXJwcmV0cyB0aGUgZGF0YSBhc1xuICAgKiBldmVudHMgYW5kIHJldHVybnMgdGhlIGZ1bGwgZXZlbnQgc3RyZWFtLlxuICAgKlxuICAgKiBAcGFyYW0gdXJsIHRoZSBlbmRwb2ludCBVUkwuXG4gICAqIEBwYXJhbSBvcHRpb25zIGFuIG9iamVjdCBvZiBgU3NlT3B0aW9uYFxuICAgKiBAcGFyYW0gcmVxdWVzdE9wdGlvbnMgdGhlIEhUVFAgb3B0aW9ucyB0byBzZW5kIHdpdGggdGhlIHJlcXVlc3QuXG4gICAqIEBwYXJhbSBtZXRob2QgdGhlIEhUVFAgbWV0aG9kXG4gICAqXG4gICAqIEByZXR1cm5zIGFuIG9ic2VydmFibGUgb2YgYWxsIGV2ZW50cyBmb3IgdGhlIHJlcXVlc3QsIHdpdGggdGhlIHJlc3BvbnNlIGJvZHkgb2YgdHlwZSBgRXZlbnRgLlxuICAgKi9cbiAgcHVibGljIHN0cmVhbSh1cmw6IHN0cmluZywgb3B0aW9ucz86IHsga2VlcEFsaXZlPzogYm9vbGVhbjsgcmVjb25uZWN0aW9uRGVsYXk/OiBudW1iZXI7IHJlc3BvbnNlVHlwZT86ICdldmVudCcgfSwgcmVxdWVzdE9wdGlvbnM/OiBTc2VSZXF1ZXN0T3B0aW9ucywgbWV0aG9kPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxFdmVudD47XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgYSByZXF1ZXN0IHdoaWNoIGxpc3RlbiB0byB0aGUgU1NFIGFuZCBpbnRlcnByZXRzIHRoZSBkYXRhIGFzIGFcbiAgICogc3RyaW5nIHRleHQgYW5kIHJldHVybnMgdGhlIGZ1bGwgZXZlbnQgc3RyZWFtLlxuICAgKlxuICAgKiBAcGFyYW0gdXJsIHRoZSBlbmRwb2ludCBVUkwuXG4gICAqIEBwYXJhbSBvcHRpb25zIGFuIG9iamVjdCBvZiBgU3NlT3B0aW9uYFxuICAgKiBAcGFyYW0gcmVxdWVzdE9wdGlvbnMgdGhlIEhUVFAgb3B0aW9ucyB0byBzZW5kIHdpdGggdGhlIHJlcXVlc3QuXG4gICAqIEBwYXJhbSBtZXRob2QgdGhlIEhUVFAgbWV0aG9kXG4gICAqXG4gICAqIEByZXR1cm5zIGFuIG9ic2VydmFibGUgb2YgYWxsIGV2ZW50cyBmb3IgdGhlIHJlcXVlc3QsIHdpdGggdGhlIHJlc3BvbnNlIGJvZHkgb2YgdHlwZSBzdHJpbmcuXG4gICAqL1xuICBwdWJsaWMgc3RyZWFtKHVybDogc3RyaW5nLCBvcHRpb25zPzogeyBrZWVwQWxpdmU/OiBib29sZWFuOyByZWNvbm5lY3Rpb25EZWxheT86IG51bWJlcjsgcmVzcG9uc2VUeXBlPzogJ3RleHQnIH0sIHJlcXVlc3RPcHRpb25zPzogU3NlUmVxdWVzdE9wdGlvbnMsIG1ldGhvZD86IHN0cmluZyk6IE9ic2VydmFibGU8c3RyaW5nPjtcblxuICBwdWJsaWMgc3RyZWFtKHVybDogc3RyaW5nLCBvcHRpb25zPzogU3NlT3B0aW9ucywgcmVxdWVzdE9wdGlvbnM/OiBTc2VSZXF1ZXN0T3B0aW9ucywgbWV0aG9kID0gJ0dFVCcpOiBPYnNlcnZhYmxlPHN0cmluZyB8IEV2ZW50PiB7XG4gICAgdGhpcy5zc2VPcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdFNzZU9wdGlvbnMsIG9wdGlvbnMpO1xuICAgIHRoaXMuaHR0cENsaWVudE9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCByZXF1ZXN0T3B0aW9ucyBhcyBhbnksIGRlZmF1bHRSZXF1ZXN0T3B0aW9ucyk7XG5cbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGU8c3RyaW5nIHwgRXZlbnQ+KChvYnNlcnZlcikgPT4ge1xuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gdGhpcy5zdWJzY3JpYmVTdHJlYW1SZXF1ZXN0KHVybCwgdGhpcy5zc2VPcHRpb25zLCB0aGlzLmh0dHBDbGllbnRPcHRpb25zLCBtZXRob2QsIG9ic2VydmVyKTtcbiAgICAgIHJldHVybiAoKSA9PiBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc3Vic2NyaWJlU3RyZWFtUmVxdWVzdCh1cmw6IHN0cmluZywgb3B0aW9uczogU3NlT3B0aW9ucywgcmVxdWVzdE9wdGlvbnM6IGFueSwgbWV0aG9kOiBzdHJpbmcsIG9ic2VydmVyOiBTdWJzY3JpYmVyPHN0cmluZyB8IEV2ZW50Pik6IFN1YnNjcmlwdGlvbiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cENsaWVudFxuICAgICAgLnJlcXVlc3Q8c3RyaW5nPihtZXRob2QsIHVybCwgcmVxdWVzdE9wdGlvbnMpXG4gICAgICAucGlwZShyZXBlYXRXaGVuKChjb21wbGV0ZWQpID0+IHRoaXMucmVwZWF0V2hlbihjb21wbGV0ZWQsIG9wdGlvbnMua2VlcEFsaXZlLCBvcHRpb25zLnJlY29ubmVjdGlvbkRlbGF5KSkpXG4gICAgICAucGlwZShyZXRyeVdoZW4oKGVycm9yKSA9PiB0aGlzLnJldHJ5V2hlbihlcnJvciwgb3B0aW9ucy5rZWVwQWxpdmUsIG9wdGlvbnMucmVjb25uZWN0aW9uRGVsYXksIG9ic2VydmVyKSkpXG4gICAgICAuc3Vic2NyaWJlKChldmVudCkgPT4gdGhpcy5wYXJzZVN0cmVhbUV2ZW50KGV2ZW50LCBvYnNlcnZlcikpO1xuICB9XG5cbiAgcHJpdmF0ZSByZXBlYXRXaGVuKGNvbXBsZXRlZDogT2JzZXJ2YWJsZTxhbnk+LCBrZWVwQWxpdmU6IGJvb2xlYW4sIHJlY29ubmVjdGlvbkRlbGF5OiBudW1iZXIpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiBjb21wbGV0ZWQucGlwZSh0YWtlV2hpbGUoKCkgPT4ga2VlcEFsaXZlKSkucGlwZShkZWxheShyZWNvbm5lY3Rpb25EZWxheSkpO1xuICB9XG5cbiAgcHJpdmF0ZSByZXRyeVdoZW4oYXR0ZW1wdHM6IE9ic2VydmFibGU8YW55Piwga2VlcEFsaXZlOiBib29sZWFuLCByZWNvbm5lY3Rpb25EZWxheTogbnVtYmVyLCBvYnNlcnZlcjogU3Vic2NyaWJlcjxzdHJpbmcgfCBFdmVudD4pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiBhdHRlbXB0c1xuICAgICAgLnBpcGUodGFwKChlcnJvcikgPT4gdGhpcy50aHJlYXRSZXF1ZXN0RXJyb3IoZXJyb3IsIG9ic2VydmVyKSkpXG4gICAgICAucGlwZSh0YWtlV2hpbGUoKCkgPT4ga2VlcEFsaXZlKSlcbiAgICAgIC5waXBlKGRlbGF5KHJlY29ubmVjdGlvbkRlbGF5KSk7XG4gIH1cblxuICBwcml2YXRlIHRocmVhdFJlcXVlc3RFcnJvcihldmVudDogSHR0cEVycm9yUmVzcG9uc2UsIG9ic2VydmVyOiBTdWJzY3JpYmVyPHN0cmluZyB8IEV2ZW50Pik6IHZvaWQge1xuICAgIHRoaXMuZGlzcGF0Y2hTdHJlYW1EYXRhKHRoaXMuZXJyb3JFdmVudChldmVudCksIG9ic2VydmVyKTtcblxuICAgIGlmICghdGhpcy5pc1ZhbGlkU3RhdHVzKGV2ZW50LnN0YXR1cykpIHtcbiAgICAgIG9ic2VydmVyLmVycm9yKGV2ZW50KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzVmFsaWRTdGF0dXMoc3RhdHVzOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gc3RhdHVzICE9PSB1bmRlZmluZWQgJiYgc3RhdHVzICE9PSBudWxsICYmIHN0YXR1cyA8PSAyOTk7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlU3RyZWFtRXZlbnQoZXZlbnQ6IEh0dHBFdmVudDxzdHJpbmc+LCBvYnNlcnZlcjogU3Vic2NyaWJlcjxzdHJpbmc+KTogdm9pZCB7XG4gICAgaWYgKGV2ZW50LnR5cGUgPT09IEh0dHBFdmVudFR5cGUuU2VudCkge1xuICAgICAgdGhpcy5wcm9ncmVzcyA9IDA7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKGV2ZW50LnR5cGUgPT09IEh0dHBFdmVudFR5cGUuRG93bmxvYWRQcm9ncmVzcykge1xuICAgICAgdGhpcy5vblN0cmVhbVByb2dyZXNzKChldmVudCBhcyBIdHRwRG93bmxvYWRQcm9ncmVzc0V2ZW50KS5wYXJ0aWFsVGV4dCwgb2JzZXJ2ZXIpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChldmVudC50eXBlID09PSBIdHRwRXZlbnRUeXBlLlJlc3BvbnNlKSB7XG4gICAgICB0aGlzLm9uU3RyZWFtQ29tcGxldGVkKGV2ZW50IGFzIEh0dHBSZXNwb25zZTxzdHJpbmc+LCBvYnNlcnZlcik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvblN0cmVhbVByb2dyZXNzKGRhdGE6IHN0cmluZywgb2JzZXJ2ZXI6IFN1YnNjcmliZXI8c3RyaW5nPik6IHZvaWQge1xuICAgIGRhdGEgPSBkYXRhLnN1YnN0cmluZyh0aGlzLnByb2dyZXNzKTtcbiAgICB0aGlzLnByb2dyZXNzICs9IGRhdGEubGVuZ3RoO1xuICAgIGRhdGEuc3BsaXQoLyhcXHJcXG58XFxyfFxcbil7Mn0vZykuZm9yRWFjaCgocGFydCkgPT4gdGhpcy5wYXJzZUV2ZW50RGF0YShwYXJ0LCBvYnNlcnZlcikpO1xuICB9XG5cbiAgcHJpdmF0ZSBvblN0cmVhbUNvbXBsZXRlZChyZXNwb25zZTogSHR0cFJlc3BvbnNlPHN0cmluZz4sIG9ic2VydmVyOiBTdWJzY3JpYmVyPHN0cmluZz4pOiB2b2lkIHtcbiAgICB0aGlzLm9uU3RyZWFtUHJvZ3Jlc3MocmVzcG9uc2UuYm9keSwgb2JzZXJ2ZXIpO1xuICAgIHRoaXMuZGlzcGF0Y2hTdHJlYW1EYXRhKHRoaXMucGFyc2VFdmVudENodW5rKHRoaXMuY2h1bmspLCBvYnNlcnZlcik7XG5cbiAgICB0aGlzLmNodW5rID0gJyc7XG4gICAgdGhpcy5wcm9ncmVzcyA9IDA7XG5cbiAgICB0aGlzLmRpc3BhdGNoU3RyZWFtRGF0YSh0aGlzLmVycm9yRXZlbnQoKSwgb2JzZXJ2ZXIpO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUV2ZW50RGF0YShwYXJ0OiBzdHJpbmcsIG9ic2VydmVyOiBTdWJzY3JpYmVyPHN0cmluZz4pIHtcbiAgICBpZiAocGFydC50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLmRpc3BhdGNoU3RyZWFtRGF0YSh0aGlzLnBhcnNlRXZlbnRDaHVuayh0aGlzLmNodW5rKSwgb2JzZXJ2ZXIpO1xuICAgICAgdGhpcy5jaHVuayA9ICcnO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNodW5rICs9IHBhcnQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUV2ZW50Q2h1bmsoY2h1bms6IHN0cmluZyk6IE1lc3NhZ2VFdmVudCB7XG4gICAgaWYgKCFjaHVuayB8fCBjaHVuay5sZW5ndGggPT09IDApIHJldHVybjtcblxuICAgIGNvbnN0IGNodW5rRXZlbnQ6IENodW5rRXZlbnQgPSB7IGlkOiBudWxsLCBkYXRhOiAnJywgZXZlbnQ6ICdtZXNzYWdlJyB9O1xuICAgIGNodW5rLnNwbGl0KC9cXG58XFxyXFxufFxcci8pLmZvckVhY2goKGxpbmUpID0+IHRoaXMucGFyc2VDaHVua0xpbmUobGluZS50cmltKCksIGNodW5rRXZlbnQpKTtcblxuICAgIHJldHVybiB0aGlzLm1lc3NhZ2VFdmVudChjaHVua0V2ZW50LmV2ZW50LCB7IGxhc3RFdmVudElkOiBjaHVua0V2ZW50LmlkLCBkYXRhOiBjaHVua0V2ZW50LmRhdGEgfSk7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlQ2h1bmtMaW5lKGxpbmU6IHN0cmluZywgZXZlbnQ6IENodW5rRXZlbnQpOiB2b2lkIHtcbiAgICBjb25zdCBpbmRleCA9IGxpbmUuaW5kZXhPZihTc2VDbGllbnQuU0VQQVJBVE9SKTtcbiAgICBpZiAoaW5kZXggPD0gMCkgcmV0dXJuIG51bGw7XG5cbiAgICBjb25zdCBmaWVsZCA9IGxpbmUuc3Vic3RyaW5nKDAsIGluZGV4KTtcbiAgICBpZiAoT2JqZWN0LmtleXMoZXZlbnQpLmZpbmRJbmRleCgoa2V5OiBzdHJpbmcpID0+IGtleSA9PT0gZmllbGQpID09PSAtMSkgcmV0dXJuO1xuXG4gICAgbGV0IGRhdGEgPSBsaW5lLnN1YnN0cmluZyhpbmRleCArIDEpO1xuICAgIGlmIChmaWVsZCA9PT0gJ2RhdGEnKSBkYXRhID0gZXZlbnQuZGF0YSArIGRhdGE7XG5cbiAgICBldmVudFtmaWVsZF0gPSBkYXRhO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXNwYXRjaFN0cmVhbURhdGEoZXZlbnQ6IEV2ZW50LCBvYnNlcnZlcjogU3Vic2NyaWJlcjx1bmtub3duPik6IHZvaWQge1xuICAgIGlmICghdGhpcy52YWxpZEV2ZW50KGV2ZW50KSkgcmV0dXJuO1xuXG4gICAgaWYgKHRoaXMuc3NlT3B0aW9ucy5yZXNwb25zZVR5cGUgPT09ICdldmVudCcpIHtcbiAgICAgIG9ic2VydmVyLm5leHQoZXZlbnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvYnNlcnZlci5uZXh0KChldmVudCBhcyBNZXNzYWdlRXZlbnQpLmRhdGEpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdmFsaWRFdmVudChldmVudDogRXZlbnQpOiBib29sZWFuIHtcbiAgICBpZiAoIWV2ZW50KSByZXR1cm4gZmFsc2U7XG4gICAgaWYgKGV2ZW50LnR5cGUgPT09ICdlcnJvcicgJiYgdGhpcy5zc2VPcHRpb25zLnJlc3BvbnNlVHlwZSAhPT0gJ2V2ZW50JykgcmV0dXJuIGZhbHNlO1xuICAgIGlmIChldmVudC50eXBlICE9PSAnZXJyb3InICYmICghKGV2ZW50IGFzIE1lc3NhZ2VFdmVudCkuZGF0YSB8fCAhKGV2ZW50IGFzIE1lc3NhZ2VFdmVudCkuZGF0YS5sZW5ndGgpKSByZXR1cm4gZmFsc2U7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIG1lc3NhZ2VFdmVudCh0eXBlOiBzdHJpbmcsIG9wdGlvbnM6IE1lc3NhZ2VFdmVudEluaXQpOiBNZXNzYWdlRXZlbnQge1xuICAgIHJldHVybiBuZXcgTWVzc2FnZUV2ZW50KHR5cGUsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBlcnJvckV2ZW50KGVycm9yPzogYW55KTogRXZlbnQge1xuICAgIGxldCBldmVudEluaXREaWN0OiBFcnJvckV2ZW50SW5pdDtcblxuICAgIGlmIChlcnJvciAmJiBlcnJvci5zdGF0dXMgPiAwKSB7XG4gICAgICBldmVudEluaXREaWN0ID0geyBlcnJvciwgbWVzc2FnZTogZXJyb3IubWVzc2FnZSB9O1xuXG4gICAgICBpZiAoIXRoaXMuaXNWYWxpZFN0YXR1cyhlcnJvci5zdGF0dXMpKSB7XG4gICAgICAgIGV2ZW50SW5pdERpY3RbJ3N0YXR1cyddID0gZXJyb3Iuc3RhdHVzO1xuICAgICAgICBldmVudEluaXREaWN0WydzdGF0dXNUZXh0J10gPSBlcnJvci5zdGF0dXNUZXh0O1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXcgRXJyb3JFdmVudCgnZXJyb3InLCBldmVudEluaXREaWN0KTtcbiAgfVxufVxuXG50eXBlIENodW5rRXZlbnQgPSB7IGlkOiBzdHJpbmc7IGRhdGE6IHN0cmluZzsgZXZlbnQ6ICdtZXNzYWdlJyB9O1xuIl19